{% extends "_base.html" %}
{% load static %}
{% load sass_tags %}

{% block page_name %}forum list{% endblock %}

{% block content %}

  {% if subsite.id == 53 %}
    {% include "metabolism_manager/_user.menu.html" %}
  {% endif %}

  {% if section == "volunteer_hub" %}
    {% include "hub/_nav.html" %}
  {% endif %}

  <div id="topic-list">
    <div class="row mb-4">
      <div class="col-md-8 mb-2">
        <input class="search form-control" type="text" name="search" placeholder="Search by title">
      </div>
      <div class="col-md-4 mb-2" style="display:none">
        <select class="custom-select tag-filter">
          <option value="all">Filter by tag</option>
          <option value="Conferences">Conferences</option>
          <option value="Data">Data</option>
          <option value="Logistics">Logistics</option>
        </select>
      </div>
      <div class="col-md-4 mb-2">
        <a class="btn btn-primary d-block" href="create/"><i class="fas fa-fw fa-comment-alt-plus"></i> Post new topic</a>
      </div>
    </div>

    <div class="card table-responsive">
      <table class="table">
        <thead>
          <tr class="d-none d-sm-table-row">
            <th class="topic">Topic</th>
            {% if False %}
              <th class="d-none d-lg-table-cell"></th>
            {% endif %}
            <th class="d-none d-sm-table-cell narrow-cell">Messages</th>
            <th class="d-none d-md-table-cell medium-cell">Activity</th>
          </tr>
        </thead>
        <tbody class="list">
          {% for each in list %}
            <tr>
              <td>
                <a href="{{ each.id }}/" class="topic-title">{{ each }}</a>
                <div style="display:none">
                <br>
                <!-- for tag in each.tags -->
                <a href="#" class="badge badge-primary">Data</a>
                <a href="#" class="badge badge-primary">Logistics</a>
                <!-- end for -->
                <span class="topic-tags" hidden>
                  <!-- for tag in each.tags -->
                  Data Logistics
                  <!-- end for -->
                </span>
                </div>
              </td>
              {% if False %}
              <td class="d-none d-lg-table-cell">
                {% if each.getReply.count > 5 %}
                  {% for subdetails in each.getReply|slice:"5" %}
                    <span class="avatar plus" title="{{ subdetails.user.first_name }} {{ subdetails.user.last_name }}">
                      {{ subdetails.user.first_name|slice:"1" }}
                    </span>
                  {% endfor %}
                  {% with count_reply=each.getReply.count|add:"-5" %}
                    <span class="avatar plus">+{{ count_reply }}</span>
                  {% endwith %}
                {% else %}
                  {% for subdetails in each.getReply %}
                    <span class="avatar plus" title="{{ subdetails.user.first_name }} {{ subdetails.user.last_name }}">
                      {{ subdetails.user.first_name|slice:"1" }}
                    </span>
                  {% endfor %}
                {% endif %}
              </td>
              {% endif %}
              <td class="d-none d-sm-table-cell narrow-cell">
                {{ each.messages.count }}
              </td>
              <td class="d-none d-md-table-cell medium-cell">
                  {{ each.last_update|timesince }} ago
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="card no-results">
      <div class="card-body text-center">
        <h2 class="my-4"><i class="fad fa-search"></i> No topics found</h2>
        <button class="btn btn-lg btn-primary clear-filter my-4">Show all topics</button>
      </div>
    </div>
  </div>
{% endblock %}

{% block footer %}
  <!-- add listjs to search and filter - https://listjs.com/api/ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>

  <script>
    var listOptions = {
      valueNames: ["topic-title", "topic-tags"]
    };

    var topicList = new List("topic-list", listOptions);

    function filterList(tag) {
      topicList.filter(function(item) {
        if (tag == "all") {
          return true;
        } else {
          console.log(item.values())
          if (item.values()["topic-tags"].includes(tag)) {
            return true;
          } else {
            return false;
          }
        }
      });

      checkCount()
    }

    $(".tag-filter").change(function() {
      var tag = $(this).val()

      filterList(tag)
    })

    // function to check the number of matches
    function checkCount() {
      var count = $("#topic-list tbody.list tr:visible").length;
      if (count == 0) {
        $(".no-results").addClass("visible");
      } else {
        $(".no-results").removeClass("visible");
      }
    }

    // update contact count when searching by name
    topicList.on("searchComplete", function(){
      checkCount();
    });

    // clear search and filters
    function resetSearchFilters() {
      topicList.search();
      filterList("all")

      $("#topic-list input.search").val("");
      $(".tag-filter").val("all")
    }

    $(".clear-filter").click(function() {
      resetSearchFilters();
      checkCount();
    })

    // reset all filters on page load
    resetSearchFilters();

    // make no results box invisible on load
    $(".no-results").removeClass("visible");
  </script>
{% endblock %}
