{% extends "_base.html" %}

{% load static %}

{% block page_name %}library search{% endblock %}

{% block css %}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@ttskch/select2-bootstrap4-theme@1.3.2/dist/select2-bootstrap4.min.css"/>
  <link rel="stylesheet" href="{% static 'css/main.css' %}">
  {% if request.GET.before or request.GET.after or request.GET.type or request.GET.space or request.GET.fields %}
    <style type="text/css">
      body.library.search .advanced-options {
        display:block;
      }
      .btn-advanced {
        display:none;
      }
    </style>
  {% endif %}
{% endblock %}

{% block content %}
  <section class="search-wrapper">
    <form class="container" method="get" id="search">
      {% spaceless %}
        <div class="search-select">
          <select class="search" name="search">
            {% if request.GET.search and not tag %}
              <option selected>{{ request.GET.search }}</option>
            {% else %}
              <option disabled hidden selected>Search through library</option>
            {% endif %}
            {% for each in tags %}
              <option value="{{ each.id }}" {% if each == tag %}selected {% endif %}>{{ each }}</option>
            {% endfor %}
          </select>

          <button class="btn btn-lg btn-primary d-inlineblock" name="find" value="true" type="submit" form="search"><i class="fas fa-search"></i> Search</button>

          <div class="">
            <label>
              <input type="checkbox" name="urban_only" value="true" {% if urban_only %}checked{% endif %} />
              Only show work on {{ SYSTEM_NAME_PLURAL }}
            </label>
          </div>
          <div class="btn btn-primary-basic btn-advanced mt-2"><i class="far fa-tools"></i> Show advanced options</div>
        </div>
      {% endspaceless %}

      <section class="advanced-options mt-4">
        <div class="row">
          <div class="col-sm-6 col-md-4">
            <div class="form-group">
              <label for="before">Published before</label>
              <input type="number" class="form-control" id="before" min="1900" max="2025" name="before" value="{{ request.GET.before }}">
            </div>
          </div>
          <div class="col-sm-6 col-md-4">
            <div class="form-group">
              <label for="after">Published after</label>
              <input type="number" class="form-control" id="after" min="1900" max="2025" name="after" value="{{ request.GET.after }}">
            </div>
          </div>
          <div class="col-sm-6 col-md-4">
            <div class="form-group">
              <label for="after">Find by place</label>
              <div><a class="btn btn-primary" href="{% url "library:casestudies" "map" %}"><i class="fa fa-globe"></i> View our map</a></div>
            </div>
          </div>
          <div class="col-sm-6 col-md-8">
            <div class="form-group">
              <label for="type">Restrict by type</label>
              <select name="type" class="type" multiple>
                {% for key,value in types %}
                  <option value="{{ key }}" {% if key in active_types %}selected{% endif %}>{{ value }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          {% if search_space %}
            <div class="col-sm-6 col-md-4">
              <div class="form-group">
                <label for="type">Reference space</label>
                <div>
                <em>{{ search_space }}</em>
                <input type="hidden" name="space" value="{{ search_space.id }}" />
                </div>
              </div>
            </div>
          {% endif %}
        </div>

        <div class="row-1">
          <div class="col-sm-6 col-md-2">
            <div class="form-group">
              <label for="fields">Search fields</label>
              <select name="fields" class="fields">  
                {% for key,value in fields %} 
                  <option value="{{ key }}" {% if key in active_fields %}selected{% endif %}>{{ value }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="col-sm-6 col-md-3">
            <div class="form-group">
              <label for="contains">Contains</label>
              <select name="contains" class="contains">
                {% for key,value in contains %}
                  <option value="{{ key }}" {% if key in active_contains %}selected{% endif %}>{{ value }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="col-sm-6 col-md-5">
            <div class="form-group">
              <label for="terms">Enter a search term for row</label>
              <input type="text" class="form-control" id="terms" name="terms" value="{{ request.GET.after }}" placeholder="Enter a search term for row">
            </div>
          </div>
          <div class="col-sm-6 col-md-1">
            <div class="form-group">
              <label for="clear-row-btn-1"></label>
              <button type="button" class="btn btn-primary clear-row-btn-1">Clear</button>
            </div>
          </div>
          <style>
            .clear-row-btn-1 {
              margin-left: 4.25rem; 
              margin-top: 0.5rem;
            }
          </style>
        </div>

        <div class="row-2">
          <div class="col-sm-6 col-md-2">
            <div class="form-group">
              <label for="boolean"></label>
              <select name="boolean" class="boolean">
                {% for key,value in boolean %}
                  <option value="{{ key }}" {% if key in active_boolean %}selected{% endif %}>{{ value }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="col-sm-6 col-md-2">
            <div class="form-group">
              <label for="fields"></label>
              <select name="fields" class="fields">  
                {% for key,value in fields %} 
                  <option value="{{ key }}" {% if key in active_fields %}selected{% endif %}>{{ value }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="col-sm-6 col-md-2">
            <div class="form-group">
              <label for="contains"></label>
              <select name="contains" class="contains">
                {% for key,value in contains %}
                  <option value="{{ key }}" {% if key in active_contains %}selected{% endif %}>{{ value }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="col-sm-6 col-md-4">
            <div class="form-group">
              <label for="terms"></label>
              <input type="text" class="form-control" id="terms" name="terms" value="{{ request.GET.after }}" placeholder="Enter a search term for row">
            </div>
          </div>
          <div class="col-sm-6 col-md-1">
            <div class="form-group">
              <label for="delete-row-btn"></label>
              <button type="button" class="btn btn-primary delete-row-btn">Delete</button>
            </div>
          </div>
          <div class="col-sm-6 col-md-1">
            <div class="form-group">
              <label for="clear-row-btn"></label>
              <button type="button" class="btn btn-primary clear-row-btn">Clear</button>
            </div>
          </div>
        </div>

        <div class="row-3">
          <div class="col-sm-6 col-md-2">
            <div class="form-group">
              <label for="add-row-btn"></label>
              <button id="add-row-btn" type="button" class="btn btn-primary">ADD NEW ROW</button>
            </div>
          </div>
          <div class="col-sm-6 col-md-2">
            <div class="form-group">
              <label for="clear-all-btn"></label>
              <button id="clear-all-btn" type="button" class="btn btn-primary">CLEAR ROWS</button>
            </div>
          </div>
          <div class="col-sm-6 col-md-2">
            <div class="form-group">
              <label for="search-advanced-btn"></label>
              <button id="search-advanced-btn" type="button" class="btn btn-primary">SEARCH</button>
            </div>
          </div>
        </div>
      </section>
    </form>
  </section>

  {% if show_results %}

    <div class="alert alert-warning text-center">
      <i class="fa fa-search"></i> Your search yielded <strong>{{ items.count }}</strong> results.
    </div>

    <section class="container pb-5">
      <h3>Publications</h3>
      {% include "_library.list.html" %}
    </section>

  {% else %}

    <section class="container">
      {{ article.content|safe }}
    </section>

    {% if PROJECT.slug == "islands" %}
      <section class="container mb-4">
        <div class="row">
          <div class="col-sm-6 col-xl-4 mb-4">
            <a class="large-icon-box" href="{% if DEBUG %}/islands{% endif %}/resources/map/">
              <div class="description">Case studies</div>
              <div class="statistic">{{ casestudies_count }} items</div>
              <i class="fad fa-globe text-success" aria-hidden="true"></i>
            </a>
          </div>
          <div class="col-sm-6 col-xl-4 mb-4">
            <a class="large-icon-box" href="{% url "islands:reviews" %}">
              <div class="description">Review papers</div>
              <div class="statistic">{{ review_count }} items</div>
              <i class="fad fa-pencil-alt text-danger" aria-hidden="true"></i>
            </a>
          </div>
          <div class="col-sm-6 col-xl-4 mb-4">
            <a class="large-icon-box" href="{% url "islands:island_ie" %}">
              <div class="description">Island Industrial Ecology</div>
              <div class="statistic">{{ ie_count }} items</div>
              <i class="fad fa-island-tropical text-warning" aria-hidden="true"></i>
            </a>
          </div>
          <div class="col-sm-6 col-xl-4 mb-4">
            <a class="large-icon-box" href="./?search=_ALL_">
              <div class="description">View all</div>
              <div class="statistic">{{ all_count }} items</div>
              <i class="fad fa-file-alt text-primary" aria-hidden="true"></i>
            </a>
          </div>
        </div>

        <a class="btn btn-primary mt-2" href="{% url "library:upload" %}">
          <i class="fas fa-file-plus fa-fw"></i> Add a missing publication
        </a>
        <a class="btn btn-primary-basic mt-2" href="{% url "library:hub" %}">
          <i class="far fa-user-plus fa-fw"></i> Join our curation team
        </a>
        <a class="btn btn-primary-basic mt-2" href="#" hidden>
          <i class="far fa-video fa-fw"></i> Watch a digital tour
        </a>
      </section>
    {% else %}
      <section class="container">
        <div class="row">
          <div class="col-sm-6 col-xl-3 mb-4">
            <a class="large-icon-box" href="{% url "library:casestudies" "map" %}">
              <div class="description">Case studies</div>
              <div class="statistic">Browse our map</div>
              <i class="fad fa-globe text-success" aria-hidden="true"></i>
            </a>
          </div>
          <div class="col-sm-6 col-xl-3 mb-4">
            <a class="large-icon-box" href="{% url "library:list" "reviews" %}">
              <div class="description">Review papers</div>
              <div class="statistic">{{ review_count }} articles</div>
              <i class="fad fa-file-alt text-danger" aria-hidden="true"></i>
            </a>
          </div>
          <div class="col-sm-6 col-xl-3 mb-4">
            <a class="large-icon-box" href="{% url "library:methods" %}">
              <div class="description">Browse by method</div>
              <div class="statistic">29 methods</div>
              <i class="fad fa-vial text-warning" aria-hidden="true"></i>
            </a>
          </div>
          <div class="col-sm-6 col-xl-3 mb-4">
            <a class="large-icon-box" href="{% url "library:list" "starterskit" %}">
              <div class="description">Starter's Kit</div>
              <div class="statistic">{{ starterskit }} articles</div>
              <i class="fad fa-play-circle text-info" aria-hidden="true"></i>
            </a>
          </div>
        </div>

        <a class="btn btn-primary mt-2" href="{% url "library:upload" %}">
          <i class="fas fa-file-plus fa-fw"></i> Add a missing publication
        </a>
        <a class="btn btn-primary-basic mt-2" href="{% url "library:hub" %}">
          <i class="far fa-user-plus fa-fw"></i> Join our curation team
        </a>
        <a class="btn btn-primary-basic mt-2" href="#" hidden>
          <i class="far fa-video fa-fw"></i> Watch a digital tour
        </a>
      </section>

    {% endif %}

    {% if PROJECT.slug != "islands" %}

      <section class="container mb-4">
        <h2>News</h2>

        <div class="row">

          {% for each in news %}
            <div class="col-lg-4 mb-sm-4 mb-lg-0">
              <a class="card btn-card" href="{% url "library:news" each.slug %}">
                {% if each.image %}
                  <img src="{{ each.image.url }}" class="card-img-top" alt="">
                {% endif %}
                <div class="card-body">
                  <h5 class="card-title">
                    {{ each }}
                    <small class="d-inline-block text-muted">{{ each.date }}</small>
                  </h5>
                  <p class="card-text">
                    {{ each.introduction }}
                  </p>
                </div>
              </a>
            </div>
          {% endfor %}

        </div>
      </section>

      <!--
      <section class="container pb-4 mb-4">
        <h2>Download or export</h2>
        <div class="row">
          <div class="col-md-4">
            <a class="btn-icon" href="/cities/the-hague/datasets/">
              <div class="title"><i class="fal fa-file-download fa-fw"></i> Download entire library</div>
              <div class="text">A CSV file of all 1,497 articles in the library</div>
            </a>
          </div>
          <div class="col-md-4">
            <a class="btn-icon" href="/cities/the-hague/datasets/">
              <div class="title"><i class="fal fa-file-download fa-fw"></i> Urban case studies</div>
              <div class="text">Download just the 597 urban case studies</div>
            </a>
          </div>
          <div class="col-md-4">
            <a class="btn-icon" href="/cities/the-hague/datasets/">
              <div class="title"><i class="fal fa-file-export fa-fw"></i> Export to Zotero</div>
              <div class="text">Manage the complete library with Zotero</div>
            </a>
          </div>
        </div>
      </section>

      -->


    {% endif %}

  {% endif %}

{% endblock %}

{% block footer %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>
<script>
  $(".btn-advanced").click(function() {
    $("section.advanced-options").show();
    $(this).hide();
  })

  $("select.search").select2({
    tags: true,
    theme: "bootstrap4",
  });

  $("select.boolean").select2({
    theme: "bootstrap4",
  });

  $("select.fields").select2({
    theme: "bootstrap4",
  });

  $("select.contains").select2({
    theme: "bootstrap4",
  });

  $("select.type").select2({
    theme: "bootstrap4",
  });

  // Add new form row button
  document.getElementById("add-row-btn").addEventListener("click", function() {
    const firstRow = document.querySelector(".row-2"); // Base row for cloning
    const lastRow = document.querySelector(".row-3");  // Reference for inserting new rows

    if (firstRow && lastRow) {
        // Clone the row
        const newRow = firstRow.cloneNode(true);

        // Clear values in cloned row
        $(newRow).find("input, select").each(function () {
            if ($(this).is("input")) {
                $(this).val(""); // Clear input fields
            } else {
                $(this).prop("selectedIndex", 0); // Reset selects to first option
            }
        });

        // Remove any Select2-generated elements before reinserting into DOM
        $(newRow).find("select").each(function () {
            let $this = $(this);

            // Destroy Select2 safely (only if initialized)
            if ($this.data('select2')) {
                $this.select2('destroy');
            }

            // Remove any Select2-related attributes
            $this.removeAttr('data-select2-id');
            $this.removeClass('select2-hidden-accessible');
            $this.next('.select2-container').remove();
        });

        // Replace the terms field with a fresh input
        const termsField = $(newRow).find(".terms"); // Assuming .terms is the class
        if (termsField.is("select")) {
          const inputField = $("<input>", {
            id: termsField.attr("id"),
            type: "text",
            name: termsField.attr("name"),
            class: "terms form-control",
            placeholder: "Enter a search term for row",
            value: termsField.attr("value"),
          });
          termsField.replaceWith(inputField);
        }

        // Insert cloned row before the last row
        $(lastRow).before(newRow);

        // Reinitialize Select2 AFTER adding newRow to DOM
        $(newRow).find("select.boolean").select2({ theme: "bootstrap4" });
        $(newRow).find("select.fields").select2({ theme: "bootstrap4" });
        $(newRow).find("select.contains").select2({ theme: "bootstrap4" });

        // Restore Select2 on the original row
        $(firstRow).find("select.boolean").select2({ theme: "bootstrap4" });
        $(firstRow).find("select.fields").select2({ theme: "bootstrap4" });
        $(firstRow).find("select.contains").select2({ theme: "bootstrap4" });

        console.log("New row added and Select2 reinitialized.");
    }
  });

  $(document).on("select2:select", ".fields", function(e) {
    let selectedValue = $(this).val();
    let rowContainer = $(this).closest(".row-1, .row-2"); // Handles both row-1 and row-2
    let termsContainer = rowContainer.find(".form-group input[name='terms'], .form-group select.terms");

    console.log("Selected field:", selectedValue);

    if (selectedValue === "tag") {
        console.log("Switching input to dropdown");

        // Replace input with a Bootstrap-styled select dropdown
        let selectDropdown = `
            <select name="terms" class="form-control terms">
                {% for each in tags %}
                  <option value="{{ each.id }}" {% if each == tag %}selected {% endif %}>{{ each }}</option>
                {% endfor %}
            </select>
        `;
        termsContainer.replaceWith(selectDropdown);
    } else {
        console.log("Keeping normal input");

        // Replace dropdown with a Bootstrap-styled text input if not "tag"
        if (termsContainer.is("select")) {
            let textInput = `<input type="text" class="form-control" name="terms" placeholder="Enter a search term for row">`;
            termsContainer.replaceWith(textInput);
        }
    }
});
$(document).ready(function () {
    let firstRow = $(".row-2").first();
    
    // Hide delete button for the first row
    firstRow.find(".delete-row-btn").hide();

    // Delete only the corresponding .row-2 when delete button is clicked
    $(document).on("click", ".delete-row-btn", function () {
        $(this).closest(".row-2").remove();
    });

    // Clear input/select fields and reset select elements to default values for row-1
    $(document).on("click", ".clear-row-btn-1", function () {
        let row = $(this).closest(".row-1");
        
        row.find("input").val(""); // Clear all input fields

        // Reset selects and trigger change event for Select2
        row.find(".fields").val(row.find(".fields option:first").val()).trigger("change");
        row.find(".contains").val(row.find(".contains option:first").val()).trigger("change");

        // Reset the terms field back to input if it was changed to a select
        let termsField = row.find(".terms");
        if (termsField.is("select")) {
            let textInput = $("<input>", {
                type: "text",
                class: "form-control terms",
                name: "terms",
                placeholder: "Enter a search term for row"
            });
            termsField.replaceWith(textInput);
        }
    });

    // Clear input/select fields and reset select elements to default values for row-2
    $(document).on("click", ".clear-row-btn", function () {
        let row = $(this).closest(".row-2");
        
        row.find("input").val(""); // Clear all input fields

        // Reset selects and trigger change event for Select2
        row.find(".boolean").val(row.find(".boolean option:first").val()).trigger("change");
        row.find(".fields").val(row.find(".fields option:first").val()).trigger("change");
        row.find(".contains").val(row.find(".contains option:first").val()).trigger("change");

        // Reset the terms field back to input if it was changed to a select
        let termsField = row.find(".terms");
        if (termsField.is("select")) {
            let textInput = $("<input>", {
                type: "text",
                class: "form-control terms",
                name: "terms",
                placeholder: "Enter a search term for row"
            });
            termsField.replaceWith(textInput);
        }
    });

    $(document).on("click", "#clear-all-btn", function () {
      // Delete all cloned .row-2 elements, leaving only the first .row-2 and .row-1
      $(".row-2").not(":first").remove(); // Remove all cloned .row-2 except the first

      // Now target the remaining .row-1 and the first .row-2
      let firstRow = $(".row-1");
      let firstRow2 = $(".row-2").first();

      // Clear input fields in both .row-1 and the first .row-2 row
      firstRow.find("input").val("");
      firstRow2.find("input").val(""); // Clear .row-2 inputs

      // Reset selects and trigger change event for Select2 in .row-1 and .row-2
      firstRow.find(".boolean").val(firstRow.find(".boolean option:first").val()).trigger("change");
      firstRow.find(".fields").val(firstRow.find(".fields option:first").val()).trigger("change");
      firstRow.find(".contains").val(firstRow.find(".contains option:first").val()).trigger("change");

      firstRow2.find(".boolean").val(firstRow2.find(".boolean option:first").val()).trigger("change");
      firstRow2.find(".fields").val(firstRow2.find(".fields option:first").val()).trigger("change");
      firstRow2.find(".contains").val(firstRow2.find(".contains option:first").val()).trigger("change");

      // Reset the terms field back to input if it was changed to a select (in both rows)
      let termsField1 = firstRow.find(".terms");
      if (termsField1.is("select")) {
          let textInput1 = $("<input>", {
              type: "text",
              class: "form-control terms",
              name: "terms",
              placeholder: "Enter a search term for row"
          });
          termsField1.replaceWith(textInput1);
      }

      let termsField2 = firstRow2.find(".terms");
      if (termsField2.is("select")) {
          let textInput2 = $("<input>", {
              type: "text",
              class: "form-control terms",
              name: "terms",
              placeholder: "Enter a search term for row"
          });
          termsField2.replaceWith(textInput2);
      }
    });

    // When a new row is added, ensure its delete button is visible
    $("#add-row-btn").on("click", function () {
        let newRow = $(".row-2").last();
        newRow.find(".delete-row-btn").show(); // Ensure delete button is shown
    });
});
</script>
{% endblock %}
