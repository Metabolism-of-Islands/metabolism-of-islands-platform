{% extends "_base.html" %}
{% load humanize %}

{% block page_name %}library item fullwidth{% endblock %}
{% block title %}{{ info }}{% endblock %}

{% block head %}
  <link rel="canonical" href="{{ info.get_full_url }}" />
  <!-- When we have fully figured all this out we can consider getting it indexed. Ensure there is a canonical link as this page is generated with various URLs -->
  <meta name="robots" content="noindex">
{% endblock %}

{% block css %}
  <style>
    .journal {
      max-height: 160px;
    }

    .videoblock {
      background: #000;
    }

    .video-embed {
      width: 100%;
      height: 70vh;
    }

    .largeicon {
      font-size: 5rem;
    }

    .top-message-box .alert {
      text-align: center;
    }

    audio {
      width: 100%;
    }

    #stacked {
      height: 700px;
    }

    #map,
    #line,
    #drilldown,
    #pie,
    #area {
      height: 500px;
    }

    .visualisations .nav-link {
      padding: .25rem;
      cursor: pointer;
    }

    .highcharts-drillup-button .highcharts-button-box {
      fill: #fff !important;
      stroke: #144d58 !important;
    }

    .highcharts-container .highcharts-drillup-button text {
      fill: #144d58 !important;
    }

    .switch-pie.disabled {
      cursor: not-allowed !important;
      background-color: #144d58 !important;
      border-color: #144d58 !important;
    }

    .current-pie {
      background: #efefef !important;
      z-index: 1000 !important;
      border-left-color: #144d58 !important;
      border-right-color: #144d58 !important;
      width: 150px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    {% if info.is_deleted %}
      .main-content .container {
        opacity: .3;
      }
    {% endif %}
  </style>
{% endblock %}

{% block content %}

{% if spaces and False %}
  <section class="fullwidth-wrapper">
    <div class="container">
      <iframe class="dataset card" src="{% url 'data:dataset' info.id %}" onload="resizeIframe(this)"></iframe>
    </div>
  </section>
{% endif %}

<div class="container">
  <div class="row">
    <div class="col-lg-4 pb-4 order-2 order-lg-1">
      {% if info.publisher.image %}
        <div class="text-center">
          <a href="{{ info.publisher.get_absolute_url }}">
            <img src="{{ info.publisher.image.url }}" class="journal rounded mt-4">
          </a>
        </div>
      {% else %}
        <div class="p-4 bg-light rounded border text-center">
          <span class="largeicon">
            <i class="fal fa-{{ info.type.icon }}"></i>
          </span>
        </div>
      {% endif %}

      {% if info.file %}
        <div class="mt-3 mb-2"><a href="{{ info.file.url }}" class="btn btn-primary"><i class="fa fa-download"></i> Download</a></div>
      {% elif info.image and info.type.name == "Image" %}
        <div class="mt-3 mb-2"><a href="{{ info.image.url }}" class="btn btn-primary"><i class="fa fa-download"></i> Download</a></div>
        {% if request.user.id == 1 %}
          <div class="mt-3 mb-2"><a href="./?reload=true" class="btn btn-warning"><i class="fa fa-sync"></i> Re-create thumbnail</a></div>
        {% endif %}
      {% endif %}

      <div class="card my-4">
        <ul class="list-group list-group-flush">

          <li class="list-group-item table-item">
            <div><i class="far fa-fw fa-{{ info.type.icon }} mr-1"></i>Type</div>
            <div>{{ info.type }}</div>
          </li>

          {% if info.publisher %}
            <li class="list-group-item table-item">
              <div><i class="far fa-fw fa-building mr-1"></i> Publisher</div>
              <div><a href="{{ info.publisher.get_absolute_url }}">{{ info.publisher }}</a></div>
            </li>
          {% endif %}

          {% if info.year %}
            <li class="list-group-item table-item">
              <div><i class="far fa-fw fa-calendar mr-1"></i> Year</div>
              <div>{{ info.year }}</div>
            </li>
          {% endif %}


          <li class="list-group-item table-item">
            <div><i class="far fa-fw fa-fingerprint mr-1"></i> ID</div>
            <div class="text-monospace">{{ info.id }}</div>
          </li>

          {% if info.author_list %}
            <li class="list-group-item">
              <i class="far fa-fw fa-user-edit mb-1 mr-1" aria-hidden="true"></i> Author(s)
              <br>
              {% if info.authors.all %}
                {% for each in info.authors %}
                  <a class="btn btn-sm btn-primary-outline mt-1" href="">{{ each }}</a>
                {% endfor %}
              {% else %}
                {{ info.get_author_citation }}
              {% endif %}
            </li>
          {% endif %}

          {% if info.tags.all %}
            <li class="list-group-item">
              <i class="far fa-fw fa-tag mb-1 mr-1" aria-hidden="true"></i> Tags
              <br>
              {% for each in info.tags.all %}
                <a class="btn btn-sm btn-primary-outline mt-1" href="{% url URLS.LIBRARY %}?find=true&amp;search={{ each.id }}&amp;types=all">{{ each }}</a>
              {% endfor %}
            </li>
          {% endif %}

          {% if info.language and not info.type.name == "Image" %}
          <li class="list-group-item table-item">
            <div><i class="far fa-fw fa-language mr-1"></i> Language</div>
            <div>{{ info.get_language_display }}</div>
          </li>
          {% endif %}

          {% if info.license %}
            <li class="list-group-item table-item">
              <div><i class="far fa-fw fa-universal-access mr-1"></i> License</div>
              <div>{{ info.license }}</div>
            </li>
          {% endif %}

          {% if info.url %}
            <li class="list-group-item table-item">
              {% if info.type.name == "Report" or info.type.name == "Dataset" or info.type.name == "Document" %}
                <div><i class="far fa-fw fa-download mr-1"></i> Download</div>
              {% else %}
                <div><i class="far fa-fw fa-link mr-1"></i> Website</div>
              {% endif %}
              <div class="text-truncate">
                <a href="{{ info.url }}">{{ info.url }}</a>
              </div>
            </li>
          {% endif %}

          {% if info.doi %}
            <li class="list-group-item">
              <i class="far fa-fw fa-tag mb-1 mr-1" aria-hidden="true"></i> DOI
              <br>
              <a class="badge badge-primary" href="https://doi.org/{{ info.doi }}">
                {{ info.doi }}
              </a>
            </li>
          {% endif %}

          {% if info.isbn %}
            <li class="list-group-item">
              <i class="far fa-fw fa-tag mb-1 mr-1" aria-hidden="true"></i> ISBN
              <br>
              <span class="badge badge-primary">{{ info.isbn }}</span>
            </li>
          {% endif %}

          {% if info.type.group == "academic" %}
          <li class="list-group-item">
            <i class="far fa-fw fa-search mb-1 mr-1" aria-hidden="true"></i> Search
            <br>
            <a class="btn btn-sm btn-primary-outline mt-1" href="https://scholar.google.com/scholar?q={{ info|urlencode }}">Google Scholar</a>
            <a class="btn btn-sm btn-primary-outline mt-1" href="https://google.com/search?q={{ info|urlencode }}">Google</a>
          </li>
          {% endif %}

          {% if info.uploader %}
          <li class="list-group-item table-item">
            <div><i class="far fa-fw fa-user mr-1"></i> Uploaded by</div>
            <div>
              <a href="{% url URLS.PROFILE info.uploader.id %}">{{ info.uploader }}</a>
            </div>
          </li>
          {% endif %}

          {% if info.processor %}
          <li class="list-group-item table-item">
            <div><i class="far fa-fw fa-user mr-1"></i> Processed by</div>
            <div>
              <a href="{% url URLS.PROFILE info.processor.id %}">{{ info.processor }}</a>
            </div>
          </li>
          {% endif %}
        </ul>
      </div>

      {% if PROJECT.id == 8 %}

        {% if info.author_list %}
          <div class="card">
            <ul class="list-group list-group-flush">
              <li class="list-group-item">
                <i class="far fa-fw fa-user-edit mb-1 mr-1" aria-hidden="true"></i>
                <strong>
                Author(s)
                </strong>
                <br>
                {{ info.author_list }}
              </li>
            </ul>
          </div>
        {% endif %}

        {% for each in authors_temp %}
          <div class="card mt-4">
            {% if each.image %}
            <a href="{% url "ascus:participant" each.id %}">
              <img class="card-img-top" src="{{ each.image.thumbnail.url }}">
            </a>
            {% endif %}
            <div class="card-body">
              <div class="mb-4">
                <span class="details">
                  {% if each.image %}
                  <a href="{% url "ascus:participant" each.id %}">
                    <strong>{{ each }}</strong>
                  </a>
                  {% else %}
                    <strong>{{ each }}</strong>
                  {% endif %}

                  {% if each.email %}
                  <br>
                  {{ each.email }}
                  {% endif %}
                </span>
              </div>

            </div>
          </div>
        {% endfor %}

      {% else %}

        {% if request.user.is_authenticated %}
          {% if curator %}
            <a href="?edit&amp;return={{ request.get_full_path }}" class="btn btn-primary"><i class="fa fa-pencil"></i> Edit</a>
          {% endif %}
          {% if curator or "datacollector" in PERMISSIONS %}
            {% if IS_DATA_PORTAL and url_processing %}

              {% if not info.meta_data.processed %}
                <a href="{% url url_processing info.id %}" class="btn btn-primary"><i class="fa fa-fw fa-layer-group"></i> Process this file</a>
              {% endif %}

              {% if request.user.is_staff and info.meta_data.processed %}
                <a href="?reset_processing=true" class="btn btn-primary"><i class="fa fa-fw fa-layer-group"></i> RESET processing</a>
                <small class="d-block my-3">
                  This means that the file can be processed again. <strong>Existing reference spaces and associated info will be lost!</strong>
                </small>
              {% endif %}

              {% if request.user.is_staff and info.meta_data.processing_error %}
                <a href="?skip_size_check=true" class="btn btn-primary"><i class="fa fa-fw fa-layer-group"></i> Overwrite large-file block</a>
                <small class="d-block my-3">
                  If you mark this, it means that all reference spaces will be imported, even if this is too large. We also mark this as
                  'ready for processing'. Only mark this if someone has finished the processing workflow and it's now in limbo until
                  this restriction is lifted.
                </small>
              {% endif %}

            {% endif %}
              <a onclick="javascript:return confirm('Are you sure?')" href="?delete&amp;return={{ request.get_full_path }}" class="btn btn-danger"><i class="fa fa-trash-alt"></i> Delete</a>
          {% endif %}
        {% endif %}

      {% endif %}

      <div class="mt-4">
        <a href="javascript:history.back()" class="btn btn-primary-outline">
          <i class="fa fa-arrow-left"></i> Back
        </a>
      </div>
    </div>
    <div class="col-lg-8 mb-4 order-1 order-lg-2">
      <h1>{{ info }}</h1>

      {% if info.image and info.type.name != "Video Recording" %}
        <img src="{{ info.image.url }}" class="img-fluid img-thumbnail rounded" alt="" />
      {% endif %}

      {% if PROJECT.slug == "islands" and info.type.name == "Dataset" %}
        <div class="alert alert-warning">
          We are currently busy importing data from our previous website --
          data visualizations and data export options will be available later
          this month (October 2020).
        </div>
      {% endif %}

      <!-- show media or export options -->
      {% if info.type.name == "Video Recording" %}
        <section class="videoblock">
          {% if info.video %}
            {{ info.video.embed|safe }}
          {% else %}
            {{ info.embed|safe }}
          {% endif %}
        </section>

      {% elif info.type.name == "Podcast" %}
        <section class="podcast">
          {% if info.file_url or info.file %}
            <div class="audioblock row mt-4">
              <div class="col-lg-6">
                 <audio controls class="rounded">
                   <source src="{% if info.file_url %}{{ info.file_url }}{% else %}{{ info.file.url }}{% endif %}" type="audio/mp3">
                   Your browser does not support the audio tag.
                </audio>
              </div>
              <div class="col-lg-6">
                <a class="btn btn-primary" href="{% if info.file_url %}{{ info.file_url }}{% else %}{{ info.file.url }}{% endif %}">
                  <i class="fa fa-download"></i> Download
                </a>
              </div>
            </div>
          {% endif %}
        </section>
      {% else %}
        {% if show_export and False %}
          <section class="export">
            <div class="row">
              <div class="col-lg-4 mb-4">
                <h4>Save</h4>
                <div class="row">
                  <div class="col-md-12">
                    <a class="btn-icon" href="#">
                      <div class="title mb-0"><i class="fal fa-save fa-fw"></i> To my collection</div>
                    </a>
                  </div>
                  <div class="col-md-12">
                    <a class="btn-icon" href="#">
                      <div class="title mb-0"><i class="fal fa-folder-plus fa-fw"></i> Create new collection</div>
                    </a>
                  </div>
                </div>
              </div>
              <div class="col-lg-8 mb-4">
                <h4>Export</h4>
                <div class="row">

                  <div class="col-md-6">
                    <button class="btn-icon">
                      <div class="title mb-0"><i class="fal fa-file-export fa-fw"></i> RIS</div>
                    </button>
                  </div>
                  <div class="col-md-6">
                    <button class="btn-icon">
                      <div class="title mb-0"><i class="fal fa-file-export fa-fw"></i> Bibtex</div>
                    </button>
                  </div>
                  <div class="col-md-6">
                    <a class="btn-icon" href="#">
                      <div class="title mb-0"><i class="fal fa-quote-right fa-fw"></i> Citation</div>
                    </a>
                  </div>
                  <div class="col-md-6">
                    <a class="btn-icon" href="javascript:print()">
                      <div class="title mb-0"><i class="fal fa-print fa-fw"></i> Print</div>
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </section>
        {% endif %}
      {% endif %}

      {% if info.description %}
        <section class="description">
          {{ info.get_description }}
        </section>
      {% endif %}

      {% if info.attachments.all or info.imported_spaces.all %}
        {% if info.type.name == "Shapefile" or info.imported_spaces.all %}
          <h3>Map</h3>
          {% if info.get_shapefile_plot %}
            {% if info.meta_data.processed and IS_DATA_PORTAL %}
              <a href="{% url URLS.MAP_ITEM info.id %}"><img src="{{ info.get_shapefile_plot }}" alt="" /></a>
            {% else %}
              <img src="{{ info.get_shapefile_plot }}" alt="" />
            {% endif %}
          {% elif info.type.name == "Shapefile" %}
            <p><em>There is no preview plot available.</em></p>
            {% if info.meta_data.shapefile_plot_error %}
              <div class="alert alert-danger"><strong>Error:</strong><br>{{ info.meta_data.shapefile_plot_error }}</div>
            {% endif %}
          {% endif %}
          {% if info.meta_data.processed and IS_DATA_PORTAL %}
            <a href="{% url URLS.MAP_ITEM info.id %}" class="btn btn-primary"><i class="fa fa-map"></i> View interactive map</a>
          {% endif %}
          {% if curator and not info.get_shapefile_plot or DEBUG %}
            <a href="?create_shapefile_plot=true" class="btn btn-default-outline"><i class="fa fa-image"></i> Create preview map now.</a>
          {% endif %}
        {% endif %}

        {% if info.attachments.all %}
          <h3 class="mt-4">Attachment(s)</h3>
          <ul>
          {% for each in info.attachments.all %}
            <li><a href="{{ each.file.url }}">{{ each }}</a> ({{ each.get_size }})</li>
          {% endfor %}
          </ul>
          {% if info.attachments.count > 2 %}
            <form method="post">
              <button type="submit" class="btn btn-default-outline" name="zipfile" value="true"><i class="fa fa-file-archive"></i> Download as zipfile</button>
              {% csrf_token %}
            </form>
          {% endif %}

        {% endif %}
      {% endif %}

      {% if request.user.is_authenticated %}
        {% if info.comments %}
          <section class="notes">
            <h3>Uploader notes</h3>
            {{ info.comments|linebreaks }}
          </section>
        {% endif %}
      {% endif %}

      {% if PROJECT.slug == "untraceable" %}
        <div class="alert alert-warning">
          Uploaded by {{ info.uploader }}
        </div>
        <h3>Uploader notes</h3>
        {{ info.comments|linebreaks }}
      {% endif %}

      {% if info.is_part_of %}
        <section class="source">
          <h3>Original source</h3>
          <p>This item is part of <a href="../{{ info.is_part_of.id }}/">{{ info.is_part_of }}</a></p>
        </section>
      {% endif %}

      {% if info.children.all %}
        <section class="children">
          <h3>Available within this {{ info.type }}</h3>
          <div class="row">
            {% for each in info.children.all %}
              <div class="col-md-6 mb-3">
                <a class="card btn-card" href="../{{ each.id }}/">
                  {% if each.image %}
                    <img src="{{ each.image.thumbnail.url }}" class="card-img-top" alt="">
                  {% endif %}
                  <div class="card-body">
                    <h5 class="card-title">{{ each }}</h5>
                    <h6 class="card-subtitle mb-2 text-muted">{{ each.type }}</h6>
                  </div>
                </a>
              </div>
            {% endfor %}
          </div>
        </section>
      {% endif %}

      {% if info.spaces.all %}
        <section class="associated-spaces">
          <h3>Associated space{{ info.spaces|pluralize }}</h3>
            {% for each in info.spaces.all %}
              {% if URLS.SPACE %}
                <a href="{% url URLS.SPACE each.id %}">{{ each }}</a>
              {% else %}
                {{ each }}
              {% endif %}
              {% if not forloop.last %},{% endif %}
            {% endfor %}
        </section>
      {% endif %}

      {% if spaces %}
        <section class="spaces">
          <h3>Part of this shapefile</h3>
          {% if spaces_message %}
            <div class="alert alert-warning">
              <i class="fa fa-info-circle"></i> {{ spaces_message }}
            </div>
          {% endif %}
          <ul class="list-group list-group-flush">
            {% for each in spaces %}
              {% if URLS.SPACE %}
                <li class="list-group-item"><a href="{% url URLS.SPACE each.id %}">{{ each }}</a></li>
              {% else %}
                <li class="list-group-item">{{ each }}</li>
              {% endif %}
            {% endfor %}
          </ul>
        </section>
      {% endif %}

      {% if request.user.id == 1 %}
        {% if info.data.all %}
          <section class="visualisations">
            <h3>Data</h3>

            <ul class="nav nav-tabs nav-justified mb-4" role="tablist">
              <li class="nav-item"><a class="nav-link" data-tab="stacked" data-viz="stacked"><i class="fal fa-fw fa-chart-bar"></i> Bar</a></li>
              <li class="nav-item"><a class="nav-link" data-tab="drilldown" data-viz="drilldown" data-drilldown="true"><i class="fal fa-fw fa-chart-bar"></i> Drilldown</a></li>
              <li class="nav-item"><a class="nav-link" data-tab="line" data-viz="line"><i class="fal fa-fw fa-chart-line"></i> Line</a></li>
              <li class="nav-item"><a class="nav-link" data-tab="area" data-viz="area"><i class="fal fa-fw fa-chart-area"></i> Area</a></li>
              <li class="nav-item"><a class="nav-link" data-tab="pie-wrapper" data-viz="pie"><i class="fal fa-fw fa-chart-pie"></i> Pie</a></li>
              <li class="nav-item"><a class="nav-link" data-tab="map" data-viz="map"><i class="fal fa-fw fa-map-marked"></i> Map</a></li>
              <li class="nav-item"><a class="nav-link" data-tab="table"><i class="fal fa-fw fa-table"></i> Table</a></li>
              {% if request.user.is_superuser %}
                <li class="nav-item"><a class="nav-link" data-tab="metadata"><i class="fal fa-fw fa-info-circle"></i> Metadata</a></li>
              {% endif %}
            </ul>

            <div class="tab-content">
              <div id="stacked" role="tabpanel" class="mb-4 tab-pane">
                <h4 class="text-center"><i class="fa fa-cog fa-spin"></i> Loading</h4>
              </div>
              <div id="line" role="tabpanel" class="mb-4 tab-pane">
                <h4 class="text-center"><i class="fa fa-cog fa-spin"></i> Loading</h4>
              </div>
              <div id="area" role="tabpanel" class="mb-4 tab-pane">
                <h4 class="text-center"><i class="fa fa-cog fa-spin"></i> Loading</h4>
              </div>
              <div id="drilldown" role="tabpanel" class="mb-4 tab-pane">
                <h4 class="text-center"><i class="fa fa-cog fa-spin"></i> Loading</h4>
              </div>
              <div id="map" role="tabpanel" class="leaflet-map tab-pane">
                <h4 class="text-center"><i class="fa fa-cog fa-spin"></i> Loading</h4>
              </div>
              <div id="pie-wrapper" role="tabpanel" class="pie-wrapper mb-4 tab-pane">
                <div id="pie">
                  <h4 class="text-center"><i class="fa fa-cog fa-spin"></i> Loading</h4>
                </div>
                <div id="pie-toggles" class="text-center mt-3">
                  <div class="btn-group" role="group" aria-label="Basic example">
                    <button type="button" class="btn btn-primary switch-pie prev-pie"><i class="fa fa-arrow-left m-0"></i></button>
                    <button disabled type="button" class="btn btn-primary-outline disabled current-pie"></button>
                    <button type="button" class="btn btn-primary switch-pie next-pie"><i class="fa fa-arrow-right m-0"></i></button>
                  </div>
                </div>
              </div>
              <div id="table" role="tabpanel" class="table tab-pane">
                <table class="table datatable datatable-card">
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>Quantity</th>
                      <th>Material</th>
                      <th>From</th>
                      <th>To</th>
                    </tr>
                  </thead>
                  <tbody>
                  {% for each in info.data.all %}
                    {% if forloop.counter < 100 %}
                      <tr>
                        <td>{{ each.timeframe }}</td>
                        <td>{{ each.quantity }} {{ each.unit }}</td>
                        <td>{{ each.material_name }}</td>
                        <td>{{ each.origin_space }}</td>
                        <td>{{ each.destination_space }}</td>
                      </tr>
                    {% endif %}
                  {% endfor %}
                  </tbody>
                </table>
              </div>
              {% if request.user.is_superuser %}
              <div id="metadata" role="tabpanel" class="tab-pane">
                <span class="badge badge-primary mb-4">Available to super user only</span>

                {% if info.meta_data %}
                  <div class="card">
                    <ul class="list-group list-group-flush">
                    {% for key,value in info.meta_data.items %}
                      <li class="list-group-item table-item">
                        <div class="font-weight-bold">{{ key }}</div>
                        <div>{{ value }}</div>
                      </li>
                    {% endfor %}
                    </ul>
                  </div>
                {% else %}
                  <h5>This file has no meta data</h5>
                {% endif %}
              </div>
              {% endif %}
            </div>
          </section>
        {% endif %}
      {% endif %}

      {% if PROJECT.slug == "ascus" %}
        <section class="messages">
          {% include "_messages.html" %}
        </section>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block footer %}
  <script>
    const defaultFont = "Lato, Helvetica Neue, Arial, Helvetica, sans-serif";
    const defaultColors = ["#144d58", "#ff8a4e", "#ED561B", "#DDDF00", "#24CBE5", "#64E572", "#FF9655", "#FFF263", "#6AF9C4"]

    Highcharts.setOptions({
      colors: defaultColors,
      fontFamily: defaultFont,
      chart: {
        backgroundColor: "#fcfcfc",
        animation: false,
      },
      legend: {
        backgroundColor: "#fff",
        borderColor: "#dee2e6",
        borderWidth: 1,
      },
      credits: {
        text: "Generated by Metabolism of Cities",
        href: null,
        position: {
          y: -3,
          align: "center",
        },
        style: {
          fontSize: "12px",
          cursor: "default",
        },
      },
    });

    function createStackedBar(data) {
      Highcharts.chart("stacked", {
        chart: {
          type: "bar",
        },
        title: {
          text: "Stacked bar chart"
        },
        xAxis: {
          categories: data.x_axis
        },
        yAxis: {
          min: 0,
          title: {
            text: "{{ info }}"
          },
          stackLabels: {
            enabled: true,
            style: {
              color: "#212529"
            }
          }
        },
        legend: {
          reversed: true,
        },
        tooltip: {
          headerFormat: "<b>{point.x}</b><br/>",
          pointFormat: "{series.name}: {point.y}<br/>Total: {point.stackTotal}"
        },
        plotOptions: {
          series: {
            stacking: "normal",
          }
        },
        series: data.series
      });
    }

    function createLine(data) {
      Highcharts.chart("line", {
        title: {
          text: "Line graph"
        },
        yAxis: {
          min: 0,
          title: {
            text: "{{ info }}"
          },
        },
        xAxis: {
          categories: data.x_axis
        },
        tooltip: {
          headerFormat: "<b>{point.x}</b><br/>",
          pointFormat: "{series.name}: {point.y}<br/>Total: {point.stackTotal}"
        },
        plotOptions: {
          series: {
            marker: {
              enabled: false,
              symbol: "circle",
            }
          }
        },
        series: data.series
      });
    };

    function createArea(data) {
      Highcharts.chart("area", {
        chart: {
          type: "area"
        },
        title: {
          text: "Area graph"
        },
        yAxis: {
          min: 0,
          title: {
            text: "{{ info }}"
          },
        },
        xAxis: {
          categories: data.x_axis
        },
        tooltip: {
          headerFormat: "<b>{point.x}</b><br/>",
          pointFormat: "{series.name}: {point.y}<br/>Total: {point.stackTotal}"
        },
        plotOptions: {
          area: {
            stacking: "normal",
            lineColor: "#fcfcfc",
            lineWidth: 1,
            marker: {
              enabled: false,
              lineWidth: 1,
              lineColor: "#fcfcfc",
              symbol: "circle",
            }
          },
        },
        series: data.series
      });
    };

    function createDrilldown(data) {
      Highcharts.chart("drilldown", {
        chart: {
          type: "bar",
        },
        title: {
          text: "Drilldown bar chart"
        },
        xAxis: {
          type: "category"
        },
        yAxis: {
          min: 0,
          title: {
            text: "{{ info }}"
          },
          stackLabels: {
            style: {
              color: "#212529"
            }
          }
        },
        legend: {
          enabled: false,
        },
        tooltip: {
          headerFormat: "<b>{point.name}</b>",
          pointFormat: "{point.y:.0f}"
        },
        plotOptions: {
          series: {
            borderWidth: 0,
            dataLabels: {
              enabled: true,
              format: "{point.y:.0f}"
            }
          }
        },
        series: [
          {
            name: "Months",
            data: data.top_level
          }
        ],
        drilldown: {
          series: data.series
        }
      });
    };

    // pie chart variables, global so we can use them later
    let pieChart;
    let pieData = [];
    let piePeriods = [];
    let pieCurrent = 0;
    let pieLast = 0;

    function createPie(data) {
      pieData = data.series;
      piePeriods = data.x_axis;

      pieChart = Highcharts.chart("pie", {
        chart: {
          plotBackgroundColor: null,
          plotBorderWidth: null,
          plotShadow: false,
          type: "pie"
        },
        title: {
          text: "Pie chart"
        },
        tooltip: {
          pointFormat: "<b>{point.y:.0f}</b>"
        },
        plotOptions: {
          pie: {
            dataLabels: {
              enabled: false
            },
            showInLegend: true
          }
        },
        series: [{
          name: "Periods",
          colorByPoint: true,
          data: [{
              name: 'Chrome',
              y: 61.41,
          }, {
              name: 'Internet Explorer',
              y: 11.84
          }, {
              name: 'Firefox',
              y: 10.85
          }, {
              name: 'Edge',
              y: 4.67
          }, {
              name: 'Safari',
              y: 4.18
          }, {
              name: 'Other',
              y: 7.05
          }]
        }]
      });

      $(".switch-pie").click(function() {
        let period = $(this).attr("data-period");
        openPie(period);
      })

      pieLast = piePeriods.length - 1;
      openPie(pieCurrent)
    };

    function openPie(period) {
      let periodValues = []

      $(pieData).each(function() {
        periodValues.push({
          name: this.name,
          y: this.data[period],
        });
      });

      pieChart.series[0].setData(periodValues);

      // various functions to update the toggles
      // to start, show current period in toggle menu
      $(".current-pie").text(piePeriods[period])

      let prevPeriod = Number(period) - 1;
      let nextPeriod = Number(period) + 1;

      // use this to update the buttons, making sure to disable them when on first or last period
      if (period == 0) {
        $(".prev-pie").addClass("disabled");
      } else {
        $(".prev-pie").removeClass("disabled").attr("data-period", prevPeriod);
      }

      if (period == pieLast) {
        $(".next-pie").addClass("disabled");
      } else {
        $(".next-pie").removeClass("disabled").attr("data-period", nextPeriod);
      }
    }

{% with link=PROJECT.slug|add:":library_data_json" %}
  // some variables we'll need later
  let dataDefault;
  let dataDrill;

  let dataDefaultLoaded = false;
  let dataDrillLoaded = false;

  let stackedLoaded = false;
  let drilldownLoaded = false;
  let lineLoaded = false;
  let areaLoaded = false;
  let pieLoaded = false;
  let mapLoaded = false;

  $(".visualisations .nav-link").click(function() {
    let nav = $(this);
    let tab = nav.data("tab");
    let viz = nav.data("viz");

    $(".visualisations .nav-link, .tab-content .tab-pane").removeClass("active");
    $(".tab-pane#" + tab).addClass("active");
    nav.addClass("active");

    if (nav.data("drilldown") == true) {
      if (dataDrillLoaded == false) {
        $.get("{% url link info.id %}?drilldown=true", function(data) {
          dataDrill = data;
          dataDrillLoaded = true;
          $(".tab-pane[data-drilldown='true']").removeClass("loading");
          createViz(viz)
        });
      } else {
        createViz(viz)
      }
    } else {
      if (dataDefaultLoaded == false) {
        $.get("{% url link info.id %}", function(data) {
          dataDefault = data;
          dataDefaultLoaded = true;
          $(".tab-pane[data-drilldown!='true']").removeClass("loading");
          createViz(viz)
        });
      } else {
        createViz(viz)
      }
    }
  })

  function createViz(viz) {
    if (viz == "stacked" && stackedLoaded == false) {
      createStackedBar(dataDefault);
      stackedLoaded = true
    } else if (viz == "drilldown" && drilldownLoaded == false) {
      createDrilldown(dataDrill)
      drilldownLoaded = true
    } else if (viz == "line" && lineLoaded == false) {
      createLine(dataDefault)
      lineLoaded = true
    } else if (viz == "area" && areaLoaded == false) {
      createArea(dataDefault)
      areaLoaded = true
    } else if (viz == "pie" && pieLoaded == false) {
      createPie(dataDefault)
      pieLoaded = true
    } else if (viz == "map" && mapLoaded == false) {
      createMap(dataDefault)
      mapLoaded = true
    }
  }

  // first visualisation to open
  $(".nav-link[data-tab='stacked']").click();
{% endwith %}
</script>
{% endblock %}
