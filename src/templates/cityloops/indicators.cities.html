{% extends "_base.html" %}
{% load static %}

{% block css %}
  <style>
    table.indicators-table {
      overflow-x: auto;
    }

    tbody td:not(:first-of-type) {
      border-left: solid 1px #dee2e6;
    }

    th.city {
      white-space: nowrap;
    }

    td.indicator-text {
      text-overflow: ellipsis;
      overflow: hidden;
      white-space: nowrap;
      max-width: 300px;
    }

    th.sticky-top {
      top: 0;
    }

    td[data-city] {
      min-width: 110px;
    }

    .filters label {
      margin-bottom: 0;
      font-weight: bold;
    }

    .badge.faded {
      opacity: .1;
    }

    .select2-container--bootstrap4 .select2-results > .select2-results__options {
      max-height: 300px;
    }
  </style>
{% endblock %}

{% block content %}
  <h1>Indicators: cities' selections</h1>

  <div class="filters row">
    <div class="col-md-3">
      <div class="form-group">
        <label for="scales">Scales</label>
        <select id="scales" class="custom-select">
          <option value="all">Show all</option>
          <option value="c">City</option>
          <option value="da">Demonstration action</option>
          <option value="s">Sector</option>
        </select>
      </div>
    </div>
    <div class="col-md-9">
      <div class="form-group">
        <label for="cities">Cities</label>
        <select id="cities" class="custom-select" multiple>
          <option selected value="apeldoorn">Apeldoorn</option>
          <option selected value="bodo">Bodø</option>
          <option selected value="hoje">Høje-Taastrup</option>
          <option selected value="mikkeli">Mikkeli</option>
          <option selected value="porto">Porto</option>
          <option selected value="roskilde">Roskilde</option>
          <option selected value="sevilla">Sevilla</option>
        </select>
      </div>
    </div>
  </div>

  <div class="card card-table mb-4">
    <table class="table indicators-table">
      <thead>
        <tr>
          <th class="sticky-top indicator-text">Indicator</th>
        </tr>
      </thead>
      <tbody>
        {% for each in indicator_list %}
          {% ifchanged each.vision_element %}
            <tr>
              <td colspan="6" class="ve bg-light font-weight-bold">
                {{ each.vision_element }}. {{ each.get_vision_element_display }}
              </td>
            </tr>
          {% endifchanged %}
          <tr>
            <td>{{ each }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% endblock %}

{% block footer %}
  <script>
    // filter by scale
    $("select#scales").change(function() {
      let scale = $("select#scales").val();

      if (scale == "all") {
        $("table [data-scale]").removeClass("faded");
      } else {
        $("table [data-scale]").addClass("faded");
        $("table [data-scale='" + scale + "']").removeClass("faded");
      }

    })

    // filter cities
    $("select#cities").select2({
      closeOnSelect: false,
      theme: "bootstrap4",
    }).on("select2:unselecting", function() {
        $(this).data("unselecting", true);
    }).on("select2:opening", function(e) {
      if ($(this).data("unselecting")) {
        $(this).removeData("unselecting");
        e.preventDefault();
      }
    });


    $("select#cities").change(function() {
      let cities = $("select#cities").val();

      $("table [data-city]").attr("hidden", "hidden");

      $(cities).each(function() {
        $("table [data-city='" + this + "']").removeAttr("hidden");
      })
    })
  </script>
{% endblock %}