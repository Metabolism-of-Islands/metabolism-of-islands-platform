{% extends "_base.html" %}
{% load static %}

{% block title %}Material Stocks{% endblock %}
{% block page_name %}material-stocks map{% endblock %}

{% block head %}
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
        integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
        crossorigin=""/>

  <!-- slider filter -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/11.0.2/css/bootstrap-slider.min.css">

  <!-- fullscreen plugin -->
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/leaflet.fullscreen.css">

  <style>
    .chart .bar {
      height: 5px;
    }

    .chart .bar.selected {
      background-color: gold !important;
    }

    #start-line {
      height: 100%;
      width: 1px;
      background-color: black;
      position: absolute;
      top: 0;
      left: 0;
    }

    #average-line {
      height: 100%;
      width: 0px;
      border-right: dashed 1px black;
      position: absolute;
      top: 0;
    }

    .labels {
      font-size: .75rem;
      line-height: .75rem;
    }

    .details {
      border: 2px solid rgba(0, 0, 0, 0.2);
      background-clip: padding-box;
      border-radius: .25rem;
    }

    .details div {
      display: inline-block;
      background-color: #fff;
      padding: 0 .5rem;
      height: 30px;
      line-height: 30px;
    }

    .details .space-name {
      border-radius: .25rem 0 0 .25rem;
      border-right: 1px solid rgba(0, 0, 0, 0.2);
    }

    .details .value {
      border-radius: 0 .25rem .25rem 0;
    }

    .compact-table-wrapper {
      font-size: .75rem;
      max-height: 400px;
      overflow-y: auto;
    }

    .compact-table tr.selected {
      background-color: gold;
    }
  </style>
{% endblock %}

{% block content %}
  {% include "_submenu-stocks.html" %}

  <section>
    {% if box %}
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          {% if request.GET.source_box %}
            <li class="breadcrumb-item"><a href="{% url 'stocks:map' space.slug box.source.id request.GET.source_box %}">{{ box.source }}</a></li>
          {% else %}
            <li class="breadcrumb-item"><a href="{% url 'stocks:map' space.slug box.source.id %}">{{ box.source }}</a></li>
          {% endif %}
          <li class="breadcrumb-item active" aria-current="page">{{ box }}</li>
        </ol>
      </nav>
    {% endif %}

    <div class="row">
      <div class="col-lg-4">
        <!-- spaces chart -->
        <div class="chart-wrapper mb-4">
          <div class="chart position-relative">
            <div class="bars">
              {% for each in data.features %}
                <div class="bar" data-space="{{ each.id }}" data-value="{{ each.properties.quantity }}"></div>
              {% endfor %}
            </div>
            <div id="start-line"></div>
            <div id="average-line"></div>
          </div>
          <div class="labels">
            <span class="start-label">0</span>
            <span class="average-label position-absolute"></span>
            <span class="end-label text-right float-right"></span>
          </div>
        </div>

        <div class="compact-table-wrapper">
          <table class="table compact-table table-sm">
            {% for each in data.features %}
            <tr data-space="{{ each.id }}">
              <th>{{ each.properties.space_name }}</th>
              <td>{{ each.properties.quantity }}</td>
            </tr>
            {% endfor %}
          </table>
        </div>
      </div>
      <div class="col-lg-8">
        <div id="map" class="leaflet-map"></div>
      </div>
    </div>
  </section>

  <section>
    <table class="table datatable">
      <thead>
        <tr>
          <th>Name</th>
          <th>ID</th>
          <th>Quantity</th>
        </tr>
      </thead>
      <tbody>
        {% for each in data.features %}
        <tr>
          {% if link %}
            <td><a href="{% url 'stocks:map' space.slug link each.id %}">{{ each.properties.space_name }}</a></td>
          {% else %}
            <td>{{ each.properties.space_name }}</td>
          {% endif %}
            <td>{{ each.id }}</td>
            <td>{{ each.properties.quantity }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </section>

{% endblock %}

{% block footer %}

<!-- leaflet -->
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
  integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
  crossorigin=""></script>

<!-- leaflet fullscreen plugin - https://github.com/Leaflet/Leaflet.fullscreen -->
<script src="https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/Leaflet.fullscreen.min.js"></script>

<!-- download map as image -->
<script src="https://unpkg.com/leaflet-image@0.4.0/leaflet-image.js"></script>


<script>
  // set up map
  var map = L.map("map", {
    renderer: L.canvas(),
    fullscreenControl: true,
    scrollWheelZoom: false,
  });

  // add basemap
  L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
      attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
      maxZoom: 20,
      id: "mapbox/streets-v11",
      tileSize: 512,
      zoomOffset: -1,
      accessToken: "pk.eyJ1IjoibWV0YWJvbGlzbW9mY2l0aWVzIiwiYSI6ImNqcHA5YXh6aTAxcmY0Mm8yMGF3MGZjdGcifQ.lVZaiSy76Om31uXLP3hw-Q",
  }).addTo(map);

  // BOUNDING BOX START -- ONLY NECESSARY IF IT EXSTS
  {% if box.geometry.geojson %}
    // set style
    const boundingStyle = {
      fillColor: "transparent",
      weight: 3,
      opacity: 1,
      color: "black",
    };

    // bounding box data variable, add it to the map,
    let boundingData = {{ box.geometry.geojson|safe }};
    let boundingLayer = L.geoJson(boundingData, {
      style: boundingStyle,
      interactive: false
    });

    map.addLayer(boundingLayer)
  {% endif %}
  // BOUNDING BOX END

  // DATA LAYER START
  // set the color based on a value
  function getColor(n) {
    return n > 150 ? "#144d58" :
           n > 100 ? "#4b8793" :
           n > 50  ? "#8bc3ce" :
                     "#b3dde6";
  }

  // apply style to each feature
  function dataStyle(feature) {
    return {
      fillColor: getColor(feature.properties.quantity),
      weight: 1,
      opacity: 1,
      color: "white",
      fillOpacity: 0.7
    };
  }

  // function when hovering over an area
  function hoverArea(e) {
    var layer = e.target;

    layer.setStyle({
      weight: 2,
      color: "gold",
    });

    var layerID = layer.feature.id

    $(".chart .bar[data-space='" + layerID + "'], .compact-table tr[data-space='" + layerID + "']").addClass("selected");

    details.update(layer.feature.properties);

    if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
      layer.bringToFront();
    }
  }

  // function when hovering out of an area
  function resetHover(e) {
    var layer = e.target;
    dataLayer.resetStyle(layer);
    var layerID = layer.feature.id
    details.update();

    $(".chart .bar[data-space='" + layerID + "'], .compact-table tr[data-space='" + layerID + "']").removeClass("selected");
  }

  // function that highlights the area on the map, in the chart, and table
  function highlight(id) {
    // https://gis.stackexchange.com/questions/154310/selecting-features-by-attribute-in-leaflet
  }

  // function when clicking on an area
  function selectArea(e) {
    var layer = e.target;

    layer.setStyle({
      weight: 2,
      color: "gold",
    });
  }

  // function to apply to each feature
  function onEachFeature(feature, layer) {
    layer.on({
      mouseover: hoverArea,
      mouseout: resetHover,
      click: selectArea
    }){% if link %}.bindPopup("<h5>" + layer.feature.properties.space_name + "</h5><a class='btn btn-primary' href='" + layer.feature.link + "'><i class='fa fa-search-plus'></i> Explore area</a>");{% endif %}
  }

  // variable for the data, add it to the map
  let mapData = {{ data|safe|escape }};
  let dataLayer = L.geoJson(mapData, {
    style: dataStyle,
    onEachFeature: onEachFeature,
  })
  map.addLayer(dataLayer);
  // DATA LAYER END

  // set bounds of map to bounding box if it exists, otherwise to data layer
  {% if box.geometry.geojson %}
    map.fitBounds(boundingLayer.getBounds())
  {% else %}
    map.fitBounds(dataLayer.getBounds())
  {% endif %}

  // LEGEND START
  // create variable for the legend
  var mapDataLegend = L.control({
    position: "bottomright"
  });

  // when the legend is added to the map, build up the contents
  mapDataLegend.onAdd = function(map) {
    var div = L.DomUtil.create("div", "legend"),
        grades = [0, 50, 100, 150],
        labels = [];

    div.innerHTML = "<div>Wood stock per building<br>(in tonnes)</div><hr class='my-2'>"

    // loop through our schauff intervals and generate a label with a colored square for each interval
    for (var i = 0; i < grades.length; i++) {
        div.innerHTML +=
            "<i style='background:" + getColor(grades[i] + 1) + "'></i> " +
            grades[i] + (grades[i + 1] ? " – " + grades[i + 1] + "<br>" : "+");
    }

    return div;
  };

  // add legend to map
  map.addControl(mapDataLegend);

  // LEGEND END

  // FEATURE DETAILS START

  // add control that shows details on hover
  var details = L.control();

  details.onAdd = function(map) {
    this._div = L.DomUtil.create("div", "details");
    this.update();
    return this._div;
  };

  details.update = function(properties) {
    this._div.innerHTML = (properties ?
      "<div class='space-name'>" + properties.space_name + "</div><div class='value'>" + properties.quantity + "</div>" :
      "<div class='space-name'>{{ box }}</div><div class='value'>123</div>");
  };

  details.addTo(map);

  // FEATURE DETAILS END

  // DOWNLOAD MAP AS IMAGE START
  // function to convert canvas data to png and simulate click on download button
  function downloadImage(err, canvas) {
    var downloadLink = document.createElement("a");
    downloadLink.href = canvas.toDataURL("image/png");
    downloadLink.download = "map.png";
    downloadLink.click();
  }

  // define the download button's details
  L.Control.Download = L.Control.extend({
    onAdd: function(map) {

      var downloadButtonWrapper = L.DomUtil.create("div", "download-map-wrapper");

      var downloadButton = L.DomUtil.create("div", "download-map");
      downloadButton.innerHTML = "<i class='fal fa-fw fa-save'></i>";

      downloadButtonWrapper.appendChild(downloadButton);

      return downloadButtonWrapper;
    }
  });

  // create a new leaflet control and apply download button details
  L.control.Download = function(opts) {
    return new L.Control.Download(opts);
  }

  // add download button to the map
  L.control.Download({ position: "topleft" }).addTo(map);

  // run function when clicking the button
  $(".download-map").click(function() {
    leafletImage(map, downloadImage);
  })
  // DOWNLOAD MAP END

  // BAR GRAPH START
  // get the highest values of the dataset
  let dataValues = [{% for each in data.features %}{{ each.properties.quantity }}, {% endfor %}]
  let maxValue = Math.max(...dataValues);

  // set end label to max value
  $(".end-label").text(maxValue);

  // apply width and color to each bar
  $(".chart .bar").each(function() {
    let value = $(this).data("value");
    let width = value / maxValue * 100;
    let height = 400 / dataValues.length;

    if (height > 5) {
      height = 5
    };

    $(this).width(width + "%").height(height).css("background-color", getColor(value));
  })

  // sort bars by value
  var bars = $(".chart .bar");
  var sortedBars = bars.sort(function (a, b) {
    return $(a).data("value") > $(b).data("value");
  });

  // set html of the charts div with sorted bars
  $(".chart .bars").html(sortedBars);

  // get average of values
  // https://stackoverflow.com/questions/10359907/how-to-compute-the-sum-and-average-of-elements-in-an-array
  const average = arr => arr.reduce( ( p, c ) => p + c, 0 ) / arr.length;
  let averageValue = average(dataValues);

  // position average line
  let averagePosition = averageValue / maxValue * 100;
  $("#average-line").css("left", averagePosition + "%");

  // set average label to average
  let averageLabel = $(".average-label");

  averageLabel.text(Math.round(averageValue))
  let averageLabelWidth = averageLabel.width() / 2;
  averageLabel.css("left", "calc(" + averagePosition + "% - " + averageLabelWidth + "px)");

  // BAR GRAPH END
</script>

{% endblock %}
