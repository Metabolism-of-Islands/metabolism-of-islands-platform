{% extends "_base.html" %}
{% load static %}

{% block title %}Material Stocks{% endblock %}
{% block page_name %}material-stocks map{% endblock %}

{% block head %}
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
        integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
        crossorigin=""/>

  <!-- slider filter -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/11.0.2/css/bootstrap-slider.min.css">

  <!-- fullscreen plugin -->
  <link href="https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/leaflet.fullscreen.css" rel="stylesheet" />
{% endblock %}

{% block content %}
  {% include "_submenu-stocks.html" %}

  <div id="map" class="leaflet-map"></div>

  <h2>Geojson</h2>
  {% for each in spaces %}
    <strong class="mt-3 d-block">
      {% if link %}
        <a href="{% url "stocks:map" space.slug link each.id %}">{{ each }}</a>
      {% else %}
        {{ each }}
      {% endif %}
    </strong>
    <code>{{ each.geometry.geojson|truncatechars:100 }}</code>
  {% endfor %}

  <h2>Data</h2>
  {% for each in data %}
    <strong class="mt-3 d-block">{{ each.space_name }}</strong>
    Space ID: {{ each.space }}<br>
    Quantity: {{ each.quantity }} {{ each.unit }}<br>
    Date: {{ each.date }}
  {% endfor %}

  <h2>Bounding box</h2>
  <code>{{ box.geometry.geojson }}</code>

{% endblock %}

{% block footer %}

<!-- leaflet -->
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
  integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
  crossorigin=""></script>

<!-- leaflet fullscreen plugin - https://github.com/Leaflet/Leaflet.fullscreen -->
<script src="https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/Leaflet.fullscreen.min.js"></script>

<!-- download map as image -->
<script src="https://unpkg.com/leaflet-image@0.4.0/leaflet-image.js"></script>


<script>
  var map = L.map("map", {
    renderer: L.canvas(),
    fullscreenControl: true,
  });

  L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
      attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
      maxZoom: 20,
      id: "mapbox/streets-v11",
      tileSize: 512,
      zoomOffset: -1,
      accessToken: "pk.eyJ1IjoibWV0YWJvbGlzbW9mY2l0aWVzIiwiYSI6ImNqcHA5YXh6aTAxcmY0Mm8yMGF3MGZjdGcifQ.lVZaiSy76Om31uXLP3hw-Q",
  }).addTo(map);

  // Data layer
  function getColor(n) {
    return n > 75317 ? 'green' :
           n > 75315  ? 'blue' :
           n > 75312  ? 'red' :
                      'pink';
  }

  function dataStyle(feature) {
    return {
      fillColor: getColor(feature.properties.value),
      weight: .2,
      opacity: 1,
      color: "white",
      fillOpacity: 0.7
    };
  }

  let mapData = {{ data|safe }};

  let dataLayer = L.geoJson(mapData, {style: dataStyle})
  map.addLayer(dataLayer);

  // Bounding box
  {% if box.geometry.geojson %}
    const boundingStyle = {
      fillColor: "transparent",
      weight: 3,
      opacity: 1,
      color: "black",
      fillOpacity: 0
    };

    let boundingData = {{ box.geometry.geojson|safe }};
    let boundingLayer = L.geoJson(boundingData, {style: boundingStyle})

    map.addLayer(boundingLayer)

    map.fitBounds(boundingLayer.getBounds())
  {% else %}
    map.fitBounds(dataLayer.getBounds())
  {% endif %}

  // download map as image
  function downloadImage(err, canvas) {
    var downloadLink = document.createElement("a");
    downloadLink.href = canvas.toDataURL("image/png");
    downloadLink.download = "map.png";

    downloadLink.click();
  }

  // download map as image button
  L.Control.Download = L.Control.extend({
    onAdd: function(map) {

      var downloadButtonWrapper = L.DomUtil.create("div", "download-map-wrapper");

      var downloadButton = L.DomUtil.create("div", "download-map");
      downloadButton.innerHTML = "<i class='fal fa-fw fa-save'></i>";

      downloadButtonWrapper.appendChild(downloadButton);

      return downloadButtonWrapper;
    }
  });

  L.control.Download = function(opts) {
    return new L.Control.Download(opts);
  }

  L.control.Download({ position: "topleft" }).addTo(map);

  // click button to download
  $(".download-map").click(function() {
    leafletImage(map, downloadImage);
  })
</script>

{% endblock %}
