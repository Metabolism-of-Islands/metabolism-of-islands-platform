{% extends "_base.html" %}
{% load static %}
{% block page_name %}dataset editor map fullwidth{% endblock %}
{% block title %}Dataset editor for Cape Town fish catch in 2013{% endblock %}

{% block head %}
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
        integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
        crossorigin=""/>
{% endblock %}

{% block content %}
  <div class="px-4">
    <h1 class="mb-0">Dataset editor</h1>
    <a href="#" class="btn btn-primary-basic mb-4">
      <i class="fal fa-angle-left"></i>
      Back to datasets
    </a>

    <div class="row pb-4">
      <div class="col-lg-6">
        <form method="submit">
          <div class="form-row">
            <div class="col-6">
              <div class="form-group">
                <label class="category">Data column</label>
                <select class="custom-select" id="data-column">
                  <option value="name">Name</option>
                  <option value="id">ID</option>
                  <option selected value="density">Density</option>
                </select>
              </div>
            </div>
            <div class="col-6">
              <div class="form-group">
                <label class="category">Map type</label>
                <select class="custom-select" id="map-type">
                  <option selected value="choropleth">Choropleth</option>
                  <option value="circles">Circles</option>
                  <option value="mircles">Markers</option>
                </select>
              </div>
            </div>
          </div>

          <!-- choropleth options -->
          <div class="map-options" data-maptype="choropleth">
            <div class="form-group">
              <label class="category mb-0">Colours</label>
              <small class="form-text text-muted mb-3 mt-0">Use a colour gradient when comparing areas based on a numerical value. Otherwise, use colours by category.</small>

              <!-- colour type -->
              <ul class="nav nav-tabs nav-fill mb-3">
                <li class="nav-item">
                  <a class="nav-link active">Colour gradient</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link">Colour by category</a>
                </li>
              </ul>

              <div data-colourtype="gradient" class="colour-options">
                <div class="input-group mb-2">
                  <div class="input-group-prepend">
                    <span class="input-group-text">Number of colours</span>
                  </div>
                  <input type="number" class="form-control" aria-label="Number of colours" placeholder="Between 2 and 12" min="2" max="12">
                  <div class="input-group-append">
                    <button class="btn btn-primary" type="button">Generate colours</button>
                  </div>
                </div>
                <div class="form-row single-bucket">
                  <div class="col-4">
                    <input class="form-control" type="number" name="from" placeholder="From" value="0">
                  </div>
                  <div class="col-4">
                    <input class="form-control" type="number" name="to" placeholder="To" value="10">
                  </div>
                  <div class="col-4">
                    <input class="form-control" type="color" name="color" value="#d5dfe3">
                  </div>
                </div>
                <div class="form-row single-bucket">
                  <div class="col-4">
                    <input class="form-control" type="number" name="from" placeholder="From" value="10">
                  </div>
                  <div class="col-4">
                    <input class="form-control" type="number" name="to" placeholder="To" value="50">
                  </div>
                  <div class="col-4">
                    <input class="form-control" type="color" name="color" value="#a5bbc0">
                  </div>
                </div>
                <div class="form-row single-bucket">
                  <div class="col-4">
                    <input class="form-control" type="number" name="from" placeholder="From" value="50">
                  </div>
                  <div class="col-4">
                    <input class="form-control" type="number" name="to" placeholder="To" value="100">
                  </div>
                  <div class="col-4">
                    <input class="form-control" type="color" name="color" value="#74969e">
                  </div>
                </div>
                <div class="form-row single-bucket">
                  <div class="col-4">
                    <input class="form-control" type="number" name="from" placeholder="From" value="100">
                  </div>
                  <div class="col-4">
                    <input class="form-control" type="number" name="to" placeholder="To" value="200">
                  </div>
                  <div class="col-4">
                    <input class="form-control" type="color" name="color" value="#44727b">
                  </div>
                </div>
                <div class="form-row single-bucket">
                  <div class="col-4">
                    <input class="form-control" type="number" name="from" placeholder="From" value="200">
                  </div>
                  <div class="col-4">
                    <input class="form-control" type="number" name="to" placeholder="To" value="2000">
                  </div>
                  <div class="col-4">
                    <input class="form-control" type="color" name="color" value="#144d58">
                  </div>
                </div>

              </div>
              <div data-colourtype="category" class="colour-options">

              </div>
            </div>
          </div>

          <!-- circle options -->
          <div class="map-options" data-maptype="circles" hidden>
            <div class="alert alert-light">
              <i class="fal fa-info-circle"></i>

            </div>
          </div>

          <!-- marker options -->
          <div class="map-options" data-maptype="markers" hidden>

          </div>

          <div class="form-group">
            <label class="category mb-0">Popup settings</label>
            <small class="form-text text-muted mb-3 mt-0">Here you can define what information will show up in the popup users see when clicking on a data point</small>
            <div class="form-row">
              <div class="col-6 mb-2">
                <select class="custom-select">
                  <option selected value="name">Name</option>
                  <option value="id">ID</option>
                  <option value="density">Density</option>
                </select>
              </div>
              <div class="col-6 mb-2">
                <input class="form-control" type="text" name="label" placeholder="Label" value="Name">
              </div>
              <div class="col-6 mb-2">
                <select class="custom-select">
                  <option value="name">Name</option>
                  <option value="id">ID</option>
                  <option selected value="density">Density</option>
                </select>
              </div>
              <div class="col-6 mb-2">
                <input class="form-control" type="text" name="label" placeholder="Label" value="People per km²">
              </div>
            </div>
          </div>

          <div class="btn btn-primary-basic btn-generate-preview" onclick="window.alert('does not do anything yet')">
            <i class="fal fa-fw fa-eye"></i>
            Generate preview
          </div>
          <button type="submit" class="btn btn-success">
            <i class="fas fa-fw fa-save"></i>
            Save
          </button>
        </form>
      </div>
      <div class="col-lg-6">
        <div class="sticky-top">
          <div id="map" class="leaflet-map"></div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block footer %}

  <!-- load leaflet -->
  <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
          integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
          crossorigin="">
  </script>

  <!-- sample data -->
  <script src="https://leafletjs.com/examples/choropleth/us-states.js"></script>

  <script>
    // map type switcher
    $("#map-type").change(function() {
      let type = $("#map-type").val();
      $(".map-options").attr("hidden", "hidden");
      $(".map-options[data-maptype='" + type + "']").removeAttr("hidden");
    });

    // form data
    // colours
    const default5 = ["#d5dfe3", "#a5bbc0", "#74969e", "#44727b", "#144d58"]

    var map = L.map("map").setView([37.8, -96], 4);

    L.tileLayer("https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWV0YWJvbGlzbW9mY2l0aWVzIiwiYSI6ImNqcHA5YXh6aTAxcmY0Mm8yMGF3MGZjdGcifQ.lVZaiSy76Om31uXLP3hw-Q", {
      maxZoom: 18,
      attribution: "Map data &copy; <a href='https://www.openstreetmap.org/'>OpenStreetMap</a> contributors, " +
        "<a href='https://creativecommons.org/licenses/by-sa/2.0/'>CC-BY-SA</a>, " +
        "Imagery © <a href='https://www.mapbox.com/'>Mapbox</a>",
      id: "mapbox/light-v10",
      tileSize: 512,
      zoomOffset: -1,
    }).addTo(map);

    // get color depending on population density value
    function getColor(d) {
      return d > 200 ? "#144d58" :
             d > 100 ? "#44727b" :
             d > 50  ? "#74969e" :
             d > 10  ? "#a5bbc0" :
                       "#d5dfe3";
    }

    // create variable for the legend
    var choroplethDensityLegend = L.control({
      position: "bottomright"
    })

    // when the legend is added to the map, build up the contents
    choroplethDensityLegend.onAdd = function(map) {
      var div = L.DomUtil.create("div", "legend"),
          grades = [0, 10, 50, 100, 200],
          labels = [];

      // loop through our density intervals and generate a label with a colored square for each interval
      for (var i = 0; i < grades.length; i++) {
          div.innerHTML +=
              "<i style='background:" + getColor(grades[i] + 1) + "'></i> " +
              grades[i] + (grades[i + 1] ? " – " + grades[i + 1] + "<br>" : "+");
      }

      return div;
    };

    map.addControl(choroplethDensityLegend);

    function style(feature) {
      return {
        weight: 1,
        opacity: 1,
        color: "white",
        fillOpacity: 0.7,
        fillColor: getColor(feature.properties.density)
      };
    }

    var choropleth = L.geoJson(statesData, {
      style: style,
    });

    var filteredLayer;

    function filterChoropleth(value) {
      map.removeLayer(window[visibleLayer]);

      let valueValue = value;

      filteredLayer = L.geoJson(statesData, {
        filter: function(feature, layer) {
          return feature.properties.density > valueValue;
        },
        style: style,
      });

      map.addLayer(filteredLayer);
      visibleLayer = "filteredLayer";
    }

    $("#filter-choropleth").click(function() {
      let value = $("input.choropleth-value").val()
      filterChoropleth(value);
    })


    var bubbles = L.circle([40,-100], {
        color: "red",
        fillColor: "#f03",
        fillOpacity: 0.5,
        radius: 500000,
    })

    var marker = L.marker([30,-90]);

    let visibleLayer = "choropleth";
    map.addLayer(window[visibleLayer]);

    $("#switch-layers").change(function() {
      let newLayer = $("#switch-layers").val();

      map.removeLayer(window[visibleLayer]);
      map.addLayer(window[newLayer]);

      visibleLayer = newLayer;
    })

    $(".download-map").click(function() {
      // leafletImage(map, downloadImage);
    })
  </script>
{% endblock %}