{% extends "_base.html" %}
{% load static %}
{% block page_name %}dataset editor fullwidth{% endblock %}
{% block title %}Dataset editor for Cape Town fish catch in 2013{% endblock %}

{% block css %}
  <link href="{% static 'css/datatables.min.css' %}" rel="stylesheet" />
{% endblock %}

{% block content %}
  <div class="px-4">
    <h1 class="mb-0">Dataset editor</h1>
    <a href="#" class="btn btn-primary-basic mb-4">
      <i class="fal fa-angle-left"></i>
      Back to datasets
    </a>

    <div class="row pb-4">
      <div class="col-lg-6">
        <form id="chart-form">
          <div class="form-row mt-4">
            <div class="col-md-6">
              <div class="form-group">
                <label class="category">Chart type</label>
                <select class="custom-select" id="chart-type">
                  <option value="column">Column</option>
                  <option value="bar">Bar</option>
                  <option value="line">Line</option>
                  <option value="pie">Pie</option>
                  <option value="area">Area</option>
                  <option value="streamgraph">Stream</option>
                  <option value="columnrange">Column range</option>
                  <option value="datetime">Time series</option>
                </select>
              </div>
            </div>
            <div class="col-md-6">
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label class="category">X-axis</label>

                <div class="form-group">
                  <label>Type</label>
                  <select class="custom-select" id="xaxis-type">
                    <option value="linear">Linear</option>
                    <option value="logarithmic">Logarithmic</option>
                    <option value="datetime">Date / time</option>
                    <option selected value="category">Category</option>
                  </select>
                </div>
                <div class="custom-control custom-switch">
                  <input type="checkbox" class="custom-control-input" id="xaxis-label">
                  <label class="custom-control-label" for="xaxis-label">Label</label>
                </div>
                <div class="form-group xaxis-label-text" hidden>
                  <input type="text" class="form-control" value="" placeholder="Label text">
                </div>
                <div class="custom-control custom-switch">
                  <input type="checkbox" class="custom-control-input" id="xaxis-range">
                  <label class="custom-control-label" for="xaxis-range">Custom range</label>
                </div>
                <div class="row xaxis-range-form" hidden>
                  <div class="col">
                    <input type="number" class="form-control" placeholder="Min" id="xaxis-min">
                  </div>
                  <div class="col">
                    <input type="number" class="form-control" placeholder="Max" id="xaxis-max">
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label class="category">Y-axis</label>

                <div class="form-group">
                  <label>Type</label>
                  <select class="custom-select" id="yaxis-type">
                    <option selected value="linear">Linear</option>
                    <option value="logarithmic">Logarithmic</option>
                    <option value="datetime">Date / time</option>
                    <option value="category">Category</option>
                  </select>
                </div>
                <div class="custom-control custom-switch">
                  <input type="checkbox" class="custom-control-input" id="yaxis-label" checked>
                  <label class="custom-control-label" for="yaxis-label">Label</label>
                </div>
                <div class="form-group yaxis-label-text">
                  <input type="text" class="form-control" placeholder="Label text" value="Catch (in tonnes)">
                </div>
                <div class="custom-control custom-switch">
                  <input type="checkbox" class="custom-control-input" id="yaxis-range">
                  <label class="custom-control-label" for="yaxis-range">Custom range</label>
                </div>
                <div class="row yaxis-range-form" hidden>
                  <div class="col">
                    <input type="number" class="form-control" placeholder="Min" id="yaxis-min">
                  </div>
                  <div class="col">
                    <input type="number" class="form-control" placeholder="Max" id="yaxis-max">
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label class="category">Color scheme</label>
            <div id="color-schemes" class="row">
              <div class="col-md-6 mb-3">
                <div class="single-scheme active" data-scheme="moc">
                  <div class='row no-gutters'>
                    <div class="col single-color" style="background-color: #144d58">&nbsp;</div>
                    <div class="col single-color" style="background-color: #a6cee3">&nbsp;</div>
                    <div class="col single-color" style="background-color: #33a02c">&nbsp;</div>
                    <div class="col single-color" style="background-color: #b2df8a">&nbsp;</div>
                    <div class="col single-color" style="background-color: #e31a1c">&nbsp;</div>
                    <div class="col single-color" style="background-color: #fb9a99">&nbsp;</div>
                    <div class="col single-color" style="background-color: #ff7f00">&nbsp;</div>
                    <div class="col single-color" style="background-color: #fdbf6f">&nbsp;</div>
                    <div class="col single-color" style="background-color: #6a3d9a">&nbsp;</div>
                    <div class="col single-color" style="background-color: #cab2d6">&nbsp;</div>
                    <div class="col single-color" style="background-color: #b15928">&nbsp;</div>
                    <div class="col single-color" style="background-color: #ffff99">&nbsp;</div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <div class="single-scheme" data-scheme="dozen">
                  <div class='row no-gutters'>
                    <div class="col single-color" style="background-color: #8dd3c7">&nbsp;</div>
                    <div class="col single-color" style="background-color: #ffffb3">&nbsp;</div>
                    <div class="col single-color" style="background-color: #bebada">&nbsp;</div>
                    <div class="col single-color" style="background-color: #fb8072">&nbsp;</div>
                    <div class="col single-color" style="background-color: #80b1d3">&nbsp;</div>
                    <div class="col single-color" style="background-color: #fdb462">&nbsp;</div>
                    <div class="col single-color" style="background-color: #b3de69">&nbsp;</div>
                    <div class="col single-color" style="background-color: #fccde5">&nbsp;</div>
                    <div class="col single-color" style="background-color: #d9d9d9">&nbsp;</div>
                    <div class="col single-color" style="background-color: #bc80bd">&nbsp;</div>
                    <div class="col single-color" style="background-color: #ccebc5">&nbsp;</div>
                    <div class="col single-color" style="background-color: #ffed6f">&nbsp;</div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <div class="single-scheme" data-scheme="pastel">
                  <div class='row no-gutters'>
                    <div class="col single-color" style="background-color: #fbb4ae">&nbsp;</div>
                    <div class="col single-color" style="background-color: #b3cde3">&nbsp;</div>
                    <div class="col single-color" style="background-color: #ccebc5">&nbsp;</div>
                    <div class="col single-color" style="background-color: #decbe4">&nbsp;</div>
                    <div class="col single-color" style="background-color: #fed9a6">&nbsp;</div>
                    <div class="col single-color" style="background-color: #ffffcc">&nbsp;</div>
                    <div class="col single-color" style="background-color: #e5d8bd">&nbsp;</div>
                    <div class="col single-color" style="background-color: #fddaec">&nbsp;</div>
                    <div class="col single-color" style="background-color: #f2f2f2">&nbsp;</div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <div class="single-scheme" data-scheme="set">
                  <div class='row no-gutters'>
                    <div class="col single-color" style="background-color: #e41a1c">&nbsp;</div>
                    <div class="col single-color" style="background-color: #377eb8">&nbsp;</div>
                    <div class="col single-color" style="background-color: #4daf4a">&nbsp;</div>
                    <div class="col single-color" style="background-color: #984ea3">&nbsp;</div>
                    <div class="col single-color" style="background-color: #ff7f00">&nbsp;</div>
                    <div class="col single-color" style="background-color: #ffff33">&nbsp;</div>
                    <div class="col single-color" style="background-color: #a65628">&nbsp;</div>
                    <div class="col single-color" style="background-color: #f781bf">&nbsp;</div>
                    <div class="col single-color" style="background-color: #999999">&nbsp;</div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <div class="single-scheme" data-scheme="accent">
                  <div class='row no-gutters'>
                    <div class="col single-color" style="background-color: #7fc97f">&nbsp;</div>
                    <div class="col single-color" style="background-color: #beaed4">&nbsp;</div>
                    <div class="col single-color" style="background-color: #fdc086">&nbsp;</div>
                    <div class="col single-color" style="background-color: #ffff99">&nbsp;</div>
                    <div class="col single-color" style="background-color: #386cb0">&nbsp;</div>
                    <div class="col single-color" style="background-color: #f0027f">&nbsp;</div>
                    <div class="col single-color" style="background-color: #bf5b17">&nbsp;</div>
                    <div class="col single-color" style="background-color: #666666">&nbsp;</div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <div class="single-scheme" data-scheme="dark">
                  <div class='row no-gutters'>
                    <div class="col single-color" style="background-color: #1b9e77">&nbsp;</div>
                    <div class="col single-color" style="background-color: #d95f02">&nbsp;</div>
                    <div class="col single-color" style="background-color: #7570b3">&nbsp;</div>
                    <div class="col single-color" style="background-color: #e7298a">&nbsp;</div>
                    <div class="col single-color" style="background-color: #66a61e">&nbsp;</div>
                    <div class="col single-color" style="background-color: #e6ab02">&nbsp;</div>
                    <div class="col single-color" style="background-color: #a6761d">&nbsp;</div>
                    <div class="col single-color" style="background-color: #666666">&nbsp;</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label class="category">Other settings</label>
            <div class="custom-control custom-switch">
              <input type="checkbox" class="custom-control-input" id="data-labels">
              <label class="custom-control-label" for="data-labels">Data labels</label>
            </div>
            <div class="custom-control custom-switch">
              <input type="checkbox" class="custom-control-input" id="legend">
              <label class="custom-control-label" for="legend">Legend</label>
            </div>
            <div class="custom-control custom-switch">
              <input type="checkbox" class="custom-control-input" id="individual-colors">
              <label class="custom-control-label" for="individual-colors">Different color for each data point</label>
            </div>
          </div>
        </form>

        <button type="submit" class="btn btn-success" form="chart">
          <i class="fas fa-fw fa-save"></i>
          Save chart
        </button>

        <button class="btn btn-primary-basic btn-generate-preview">
          <i class="fal fa-fw fa-eye"></i>
          Generate preview
        </button>
      </div>
      <div class="col-lg-6">
        <div class="card sticky-top">
          <div class="card-body" id="chart"></div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block footer %}
  <!-- load highcharts -->
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="https://code.highcharts.com/modules/exporting.js"></script>
  <script src="https://code.highcharts.com/modules/drilldown.js"></script>
  <script>
    // color scheme definitions from colorbrewer2.org combined with default MoC colours
    var moc = ["#144d58","#a6cee3","#33a02c","#b2df8a","#e31a1c","#fb9a99","#ff7f00","#fdbf6f","#6a3d9a","#cab2d6","#b15928","#ffff99"];
    var accent = ["#7fc97f","#beaed4","#fdc086","#ffff99","#386cb0","#f0027f","#bf5b17","#666666"];
    var dark = ["#1b9e77","#d95f02","#7570b3","#e7298a","#66a61e","#e6ab02","#a6761d","#666666"];
    var pastel = ["#fbb4ae","#b3cde3","#ccebc5","#decbe4","#fed9a6","#ffffcc","#e5d8bd","#fddaec","#f2f2f2"];
    var set = ["#e41a1c","#377eb8","#4daf4a","#984ea3","#ff7f00","#ffff33","#a65628","#f781bf","#999999"];
    var dozen = ["#8dd3c7","#ffffb3","#bebada","#fb8072","#80b1d3","#fdb462","#b3de69","#fccde5","#d9d9d9","#bc80bd","#ccebc5","#ffed6f"];

    // user settings
    // titles
    let title = "Cape Town fish catch in 2013";
    let subtitle = "Aquatic agriculture catch from Cape Town in 2013, measured in tonnes";

    // color scheme
    let colorScheme = moc;

    // chart types
    let chartType = "column";

    // tooltip label
    let tooltipLabel = "Catch in 2013: <b>{point.y} tonnes</b>";

    // x-axis
    let xAxisType = "category";
    let xAxisLabelText = " ";
    let xAxisMin = null;
    let xAxisMax = null;

    // y-axis
    let yAxisType = "linear";
    let yAxisLabelText = "Catch (in tonnes)";
    let yAxisMin = null;
    let yAxisMax = null;

    // other settings
    let showDataLabels = false;
    let showLegend = false;
    let showMap = true;
    let showIndividualColors = false;

    // function to gather user settings and generate dataset preview
    function generatePreview() {
      // set button icon to load
      $(".btn-generate-preview i").toggleClass("fa-cog fa-spin fa-eye");

      $("#preview").removeAttr("hidden")

      // gather user settings
      // titles
      title = $("#title").val()
      subtitle = $("#subtitle").val()

      // chart types
      chartType = $("#chart-type").val();

      // tooltip label
      tooltipLabel = $("#tooltip-label").val();

      // x-axis
      xAxisType = $("#xaxis-type").val();
      xAxisMin = $("#xaxis-range").is(":checked") ? $("#xaxis-min").val() : null;
      xAxisMax = $("#xaxis-range").is(":checked") ? $("#xaxis-max").val() : null;
      xAxisLabelText = $("#xaxis-label").is(":checked") ? $(".xaxis-label-text input").val() : " ";

      // y-axis
      yAxisType = $("#yaxis-type").val();
      yAxisMin = $("#yaxis-range").is(":checked") ? $("#yaxis-min").val() : null;
      yAxisMax = $("#yaxis-range").is(":checked") ? $("#yaxis-max").val() : null;
      yAxisLabelText = $("#yaxis-label").is(":checked") ? $(".yaxis-label-text input").val() : " ";

      // data labels
      showDataLabels = $("#data-labels").is(":checked") ? true : false;

      // legend
      showLegend = $("#legend").is(":checked") ? true : false;

      // map
      showMap = $("#map").is(":checked") ? true : false;

      // individual-colors
      showIndividualColors = $("#individual-colors").is(":checked") ? true : false;

      // take variables and apply them to the preview
      // titles
      $(".preview-title").text(title)
      $(".preview-subtitle").text(subtitle)

      // map
      if (showMap) {
        $("a.tab-map").show();
      } else {
        $("a.tab-map").hide();
      }

      // update chart
      chart.update({
        chart: {
          type: chartType,
        },
        colors: colorScheme,
        xAxis: {
          type: xAxisType,
          min: xAxisMin,
          max: xAxisMax,
          title: {
            text: xAxisLabelText
          }
        },
        yAxis: {
          type: yAxisType,
          min: yAxisMin,
          max: yAxisMax,
          title: {
            text: yAxisLabelText
          }
        },
        legend: {
          enabled: showLegend
        },
        tooltip: {
          pointFormat: tooltipLabel
        },
        plotOptions: {
          series: {
            dataLabels: {
              enabled: showDataLabels,
            },
            colorByPoint: showIndividualColors,
          }
        },
      });

      if (chartType == "pie") {
        chart.update({
          xAxis: {
            lineColor: "transparent",
            title: {
              text: null,
            },
          },
          yAxis: {
            title: {
              text: null,
            }
          },
          plotOptions: {
            series: {
              colorByPoint: true,
              dataLabels: {
                enabled: true,
              },
            }
          },
        });
      }

      // revert button icon
      $(".btn-generate-preview i").toggleClass("fa-cog fa-spin fa-eye");
      scrollToID("preview")
    }

    $(".btn-generate-preview").click(function() {
      generatePreview();
    })

    // pick color scheme
    $(".single-scheme").click(function() {
      $(".single-scheme").removeClass("active")
      $(this).addClass("active");

      let scheme = $(this).data("scheme");
      colorScheme = window[scheme]
    })

    // update initial chart type select when changing available chart types
    $(".chart-types input").change(function() {
      let type = $(this).attr("id");

      if ( $(this).is(":checked") ) {
        $("#initial-chart-type option[value='" + type + "']").removeAttr("hidden")
      } else {
        $("#initial-chart-type option[value='" + type + "']").attr("hidden", "hidden")
      }
    });

    // toggle relevant inputs for axes
    // x-axis label
    $("#xaxis-label").change(function() {
      if ( $(this).is(":checked") ) {
        $(".xaxis-label-text").removeAttr("hidden")
      } else {
        $(".xaxis-label-text").attr("hidden", "hidden")
      }
    })

    // y-axis label
    $("#yaxis-label").change(function() {
      if ( $(this).is(":checked") ) {
        $(".yaxis-label-text").removeAttr("hidden")
      } else {
        $(".yaxis-label-text").attr("hidden", "hidden")
      }
    })

    // x-axis data range
    $("#xaxis-range").change(function() {
      if ( $(this).is(":checked") ) {
        $(".xaxis-range-form").removeAttr("hidden")
      } else {
        $(".xaxis-range-form").attr("hidden", "hidden")
      }
    })

    // y-axis data range
    $("#yaxis-range").change(function() {
      if ( $(this).is(":checked") ) {
        $(".yaxis-range-form").removeAttr("hidden")
      } else {
        $(".yaxis-range-form").attr("hidden", "hidden")
      }
    })

    // highchart defaults
    const defaultFont = "Lato, Helvetica Neue, Arial, Helvetica, sans-serif";

    Highcharts.setOptions({
      lang: {
        drillUpText: "Back to {series.name}"
      }
    });

    var chart = Highcharts.chart("chart", {
      chart: {
        type: chartType,
        animation: false,
        style: {
          fontFamily: defaultFont
        },
      },

      colors: colorScheme,
      title: {
        text: title,
      },

      subtitle: {
        text: subtitle
      },

      xAxis: {
        type: xAxisType,
        lineColor: "#808080",
        title: {
          text: xAxisLabelText,
          margin: 15,
          style: {
            fontSize: "14px",
          }
        },
        labels: {
          style: {
            fontSize: "14px",
          }
        }
      },

      yAxis: {
        type: yAxisType,
        gridLineColor: "#efefef",
        lineColor: "#808080",
        title: {
          text: yAxisLabelText,
          margin: 30,
          style: {
            fontSize: "14px",
          }
        },
        labels: {
          style: {
            fontSize: "14px",
          }
        }
      },

      legend: {
        enabled: showLegend
      },

      tooltip: {
        pointFormat: tooltipLabel
      },

      exporting: {
        enabled: false,
        scale: 4,
      },

      plotOptions: {
        series: {
          animation: false,
          states: {
            inactive: {
              enabled: false
            }
          },
          dataLabels: {
            enabled: showDataLabels,
          },
          colorByPoint: showIndividualColors,
        }
      },

      credits: {
        text: "Generated by Metabolism of Cities",
        href: null,
        style: {
          fontSize: "12px",
          cursor: "default",
          height: "50px",
        },
      },

      series: [{
        name: "Sea catch",
        data: [
          {
            name: "Wild fish",
            y: 35271,
            drilldown: "Wild fish"
          },
          {
            name: "Non-fish",
            y: 14000,
            drilldown: "Non-fish"
          },
          {
            name: "Aquatic plant",
            y: 37400,
            drilldown: "Aquatic plant"
          },
        ]
      }],

      drilldown: {
        drillUpButton: {
          theme: {
            fill: "#144d58",
            color: "#fff",
            stroke: "#144d58",
            r: 4,
            states: {
              hover: {
                fill: "#0f3b43",
              },
            },
          }
        },

        activeAxisLabelStyle: {
          "color": "#144d58",
          "fontWeight": "normal",
        },

        activeDataLabelStyle: {
          "color": "#144d58",
          "fontWeight": "normal",
        },

        series: [
          {
            name: "Wild fish",
            id: "Wild fish",
            data: [
              ["Abalone", 10],
              ["Small pelagics", 14490],
              ["Hake longline", 8188],
              ["Patagonian toothfish", 120],
              ["West Coast Rock Lobster", 1205],
              ["Commercial line fishers", 3378],
              ["Sharks", 24],
              ["Tuna & swordfish longline/pelagic shark", 3256],
              ["Tuna pole", 4600],
            ]
          },
          {
            name: "Non-fish",
            id: "Non-fish",
            data: [
              ["Squid", 11000],
              ["Octopus", 3000],
            ]
          },
          {
            name: "Aquatic plant",
            id: "Aquatic plant",
            data: [
              ["Kelp", 37400],
            ]
          },
        ]
      }
    });

    // export chart buttons
    $(".export-png").click(function() {
      chart.exportChart();
    });

    $(".export-svg").click(function() {
      chart.exportChart({type:"image/svg+xml"});
    });

    // fullscreen chart button
    $(".fullscreen-chart").click(function() {
      chart.fullscreen.toggle();
    })

    // set type on default
    $(".change-chart-type").val("column");

    // change chart type
    $(".change-chart-type").change(function() {
      let chartType = $(this).val()

      chart.update({
        chart: {
          type: chartType,
        },
        xAxis: {
          lineColor: "#808080",
          title: {
            text: xAxisLabelText,
          },
        },
        yAxis: {
          title: {
            text: yAxisLabelText,
          }
        }
      });

      if (chartType == "pie") {
        chart.update({
          xAxis: {
            lineColor: "transparent",
            title: {
              text: null,
            },
          },
          yAxis: {
            title: {
              text: null,
            }
          },
          plotOptions: {
            series: {
              colorByPoint: true,
              dataLabels: {
                enabled: true,
              },
            }
          },
        });
      }
    });

    // when opening data tab, load table with ajax
    let dataLoaded = false;

    $(".nav-link.load-data").click(function() {
      console.log("hi!");
      if (!dataLoaded) {
        $.get("the/url").done(function(data) {
          $(".table-wrapper").html(data);
          dataLoaded = true;
        });
      }
    });
  </script>
{% endblock %}