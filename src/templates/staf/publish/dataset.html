{% extends "_base.html" %}
{% load static %}
{% block page_name %}dataset editor{% endblock %}
{% block title %}Dataset editor for Agricultural product and foodstuffs unloaded in the Port of Brussels 2005-2017{% endblock %}

{% block css %}
  <link href="{% static 'css/datatables.min.css' %}" rel="stylesheet" />
{% endblock %}

{% block content %}
  <h1 class="mb-0">Dataset editor</h1>
  <a href="#" class="btn btn-primary-basic mb-4">
    <i class="fal fa-angle-left"></i>
    Back to datasets
  </a>

  <section>
    <form id="dataset">
      <div class="form-group">
        <label class="category">Title</label>
        <input type="text" class="form-control" id="title" value="Agricultural product and foodstuffs unloaded in the Port of Brussels 2005-2017">
      </div>
      <div class="form-group">
        <label class="category">Subtitle</label>
        <input type="text" class="form-control" id="subtitle" value="Agricultural product and foodstuffs that are offloaded in the port of Brussels through maritime traffic">
      </div>
      <div class="row mt-4">
        <div class="col-md-6">
          <div class="form-group chart-types">
            <label class="category">Enabled chart types</label>
            <div class="custom-control custom-switch">
              <input type="checkbox" class="custom-control-input" id="column" checked>
              <label class="custom-control-label" for="column">Column</label>
            </div>
            <div class="custom-control custom-switch">
              <input type="checkbox" class="custom-control-input" id="bar" checked>
              <label class="custom-control-label" for="bar">Bar</label>
            </div>
            <div class="custom-control custom-switch">
              <input type="checkbox" class="custom-control-input" id="line">
              <label class="custom-control-label" for="line">Line</label>
            </div>
            <div class="custom-control custom-switch">
              <input type="checkbox" class="custom-control-input" id="pie">
              <label class="custom-control-label" for="pie">Pie</label>
            </div>
            <div class="custom-control custom-switch">
              <input type="checkbox" class="custom-control-input" id="datetime">
              <label class="custom-control-label" for="datetime">Time series</label>
            </div>
            <div class="custom-control custom-switch">
              <input type="checkbox" class="custom-control-input" id="area">
              <label class="custom-control-label" for="area">Area</label>
            </div>
            <div class="custom-control custom-switch">
              <input type="checkbox" class="custom-control-input" id="streamgraph">
              <label class="custom-control-label" for="streamgraph">Stream</label>
            </div>
            <div class="custom-control custom-switch">
              <input type="checkbox" class="custom-control-input" id="columnrange">
              <label class="custom-control-label" for="columnrange">Column range</label>
            </div>
            <div class="custom-control custom-switch">
              <input type="checkbox" class="custom-control-input" id="drilldown">
              <label class="custom-control-label" for="drilldown">Drilldown</label>
            </div>
          </div>

          <div class="form-group">
            <label class="category">Initial chart type</label>
            <select class="custom-select" id="initial-chart-type">
              <option value="column" selected>Column</option>
              <option value="bar">Bar</option>
              <option hidden value="line">Line</label>
              <option hidden value="pie">Pie</label>
              <option hidden value="datetime">Time series</label>
              <option hidden value="area">Area</label>
              <option hidden value="streamgraph">Stream</label>
              <option hidden value="columnrange">Column range</label>
              <option hidden value="drilldown">Drilldown</label>
            </select>
          </div>
        </div>
        <div class="col-md-6">
          <div class="form-group">
            <label class="category">X-axis</label>
            <div class="custom-control custom-switch">
              <input type="checkbox" class="custom-control-input" id="xaxis-label">
              <label class="custom-control-label" for="xaxis-label">Label</label>
            </div>
            <div class="form-group xaxis-label-text" hidden>
              <input type="text" class="form-control" value="" placeholder="Label text">
            </div>
            <div class="custom-control custom-switch">
              <input type="checkbox" class="custom-control-input" id="xaxis-range">
              <label class="custom-control-label" for="xaxis-range">Custom range</label>
            </div>
            <div class="row xaxis-range-form" hidden>
              <div class="col">
                <input type="number" class="form-control" placeholder="Min" id="xaxis-min">
              </div>
              <div class="col">
                <input type="number" class="form-control" placeholder="Max" id="xaxis-max">
              </div>
            </div>
          </div>

          <div class="form-group mt-4">
            <label class="category">Y-axis</label>
            <div class="custom-control custom-switch">
              <input type="checkbox" class="custom-control-input" id="yaxis-label" checked>
              <label class="custom-control-label" for="yaxis-label">Label</label>
            </div>
            <div class="form-group yaxis-label-text">
              <input type="text" class="form-control" placeholder="Label text" value="Population (millions)">
            </div>
            <div class="custom-control custom-switch">
              <input type="checkbox" class="custom-control-input" id="yaxis-range">
              <label class="custom-control-label" for="yaxis-range">Custom range</label>
            </div>
            <div class="row yaxis-range-form" hidden>
              <div class="col">
                <input type="number" class="form-control" placeholder="Min" id="yaxis-min">
              </div>
              <div class="col">
                <input type="number" class="form-control" placeholder="Max" id="yaxis-max">
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label class="category">Other settings</label>
        <div class="custom-control custom-switch">
          <input type="checkbox" class="custom-control-input" id="legend">
          <label class="custom-control-label" for="legend">Legend</label>
        </div>
        <div class="custom-control custom-switch">
          <input type="checkbox" class="custom-control-input" id="map">
          <label class="custom-control-label" for="map">Map</label>
        </div>
      </div>
    </form>

    <button type="submit" class="btn btn-success" form="dataset">
      <i class="fas fa-fw fa-save"></i>
      Save dataset
    </button>

    <button class="btn btn-primary-basic btn-generate-preview">
      <i class="fal fa-fw fa-eye"></i>
      Generate preview
    </button>
  </section>

  <section id="preview" hidden>
    <h2>Preview</h2>
    <p>
      Below is what users will see when opening the dataset or when it's embedded in an article. Click on the generate preview button after you alter any settings to see your changes.
    </p>

    <div class="preview-wrap">
      <h3 class="preview-title">Agricultural product and foodstuffs unloaded in the Port of Brussels 2005-2017</h3>
      <div class="preview-subtitle description mb-4">
        These are the agricultural product and foodstuffs that are offloaded in the port of Brussels through maritime traffic.
      </div>

      <div class="card">
        <div class="card-body">
          <div class="nav nav-pills nav-fill">
            <a class="nav-item nav-link active" data-toggle="tab" href="#tab-chart">
              <i class="fal fa-fw fa-analytics mr-2"></i>
              Chart
            </a>
            <a class="nav-item nav-link tab-map" data-toggle="tab" href="#tab-map">
              <i class="fal fa-fw fa-map-marked mr-2"></i>
              Map
            </a>
            <a class="nav-item nav-link" data-toggle="tab" href="#tab-quality">
              <i class="fal fa-fw fa-star mr-2"></i>
              Data quality
            </a>
            <a class="nav-item nav-link" data-toggle="tab" href="#tab-metadata">
              <i class="fal fa-fw fa-info-circle mr-2"></i>
              Metadata
            </a>
            <a class="nav-item nav-link load-data" data-toggle="tab" href="#tab-data">
              <i class="fal fa-fw fa-table mr-2"></i>
              Data
            </a>
            <a class="nav-item nav-link" data-toggle="tab" href="#tab-share">
              <i class="fal fa-fw fa-share-alt mr-2"></i>
              Share
            </a>
          </div>

          <hr class="tab-divider">

          <div class="tab-content">
            <!-- chart -->
            <div class="tab-pane show active" id="tab-chart">
              <div class="row">
                <div class="col-lg-5 mb-2 mb-lg-0">
                  <div class="input-group">
                    <div class="input-group-prepend">
                      <span class="input-group-text">Chart type</span>
                    </div>
                    <select class="custom-select change-chart-type">
                      <option value="column" selected>Column</option>
                      <option value="bar">Bar</option>
                    </select>
                  </div>
                </div>
                <div class="col-lg-7">
                  <button class="btn btn-primary float-lg-right export-svg">
                    <i class="fas fa-fw fa-save"></i>
                    Save as SVG
                  </button>
                  <button class="btn btn-primary float-lg-right mr-2 export-png">
                    <i class="fas fa-fw fa-save"></i>
                    Save as PNG
                  </button>
                  <button class="btn btn-primary-basic float-lg-right mr-2 fullscreen-chart">
                    <i class="fal fa-fw fa-compress"></i>
                    Fullscreen
                  </button>
                </div>
              </div>

              <hr class="tab-divider">

              <div id="chart"></div>
            </div>

            <!-- map -->
            <div class="tab-pane" id="tab-map">
              <img class="rounded" src="https://i.imgur.com/3MFXHD0.png">
            </div>

            <!-- data quality -->
            <div class="tab-pane" id="tab-quality">
              <div class="row">
                <div class="col-lg-6">
                  <ul class="list-group list-group-flush">
                    <li class="list-group-item table-item">
                      <div><i class="far fa-fw fa-star mr-1"></i> Reliability</div>
                      <div class="rating" data-rating="1">
                        <div class="number">1</div>
                        <div class="graph">
                          <span class="full"></span>
                          <span class="full"></span>
                          <span class="full"></span>
                          <span class="full"></span>
                          <span class="full"></span>
                        </div>
                      </div>
                    </li>
                    <li class="list-group-item table-item">
                      <div><i class="far fa-fw fa-box-full mr-1"></i> Completeness</div>
                      <div class="rating" data-rating="2">
                        <div class="number">2</div>
                        <div class="graph">
                          <span class=""></span>
                          <span class="full"></span>
                          <span class="full"></span>
                          <span class="full"></span>
                          <span class="full"></span>
                        </div>
                      </div>
                    </li>
                    <li class="list-group-item table-item">
                      <div><i class="far fa-fw fa-universal-access mr-1"></i> Access</div>
                      <div class="rating" data-rating="3">
                        <div class="number">3</div>
                        <div class="graph">
                          <span class=""></span>
                          <span class=""></span>
                          <span class="full"></span>
                          <span class="full"></span>
                          <span class="full"></span>
                        </div>
                      </div>
                    </li>
                    <li class="list-group-item table-item">
                      <div><i class="far fa-fw fa-map-marked-alt mr-1"></i> Geographical correlation</div>
                      <div class="rating" data-rating="4">
                        <div class="number">4</div>
                        <div class="graph">
                          <span class=""></span>
                          <span class=""></span>
                          <span class=""></span>
                          <span class="full"></span>
                          <span class="full"></span>
                        </div>
                      </div>
                    </li>
                  </ul>
                </div>
                <div class="col-md-6">
                  <div class="alert alert-light">
                    <strong>Reliability</strong>
                    <p>
                      Fuga officiis illum eveniet. Voluptatem qui laudantium in iure amet. Nesciunt ut omnis atque iste voluptas natus. Inventore qui officiis consequatur culpa adipisci ea adipisci quaerat.
                    </p>

                    <strong>Completeness</strong>
                    <p>
                      Nisi inventore suscipit illo iure similique assumenda. Hic beatae nihil ullam. Quis et aut iure laudantium
                    </p>

                    <strong>Access</strong>
                    <p>
                      Quia sed ea eius voluptatem. Libero cum cum assumenda quia. Quas iste eius reprehenderit libero quam fugiat beatae.
                    </p>

                    <strong>Geographical correlation</strong>
                    <p>
                      Est vel officia enim facere fuga occaecati. Exercitationem voluptate facilis ut reprehenderit quia similique. Voluptatibus nihil quia quaerat ipsam dicta et.
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <!-- metadata -->
            <div class="tab-pane" id="tab-metadata">
              <div class="row">
                <div class="col-lg-6">
                  <ul class="list-group list-group-flush">
                    <li class="list-group-item">
                      <i class="far fa-fw fa-map-marker-alt mr-1" aria-hidden="true"></i> Brussels, Belgium
                    </li>
                    <li class="list-group-item">
                      <i class="far fa-fw fa-calendar mr-1" aria-hidden="true"></i> 01 January 2012 - 31 December 2017
                    </li>
                    <li class="list-group-item">
                      <i class="far fa-fw fa-flask mb-1 mr-1" aria-hidden="true"></i> Materials
                      <br>
                      <a class="btn btn-sm btn-primary-outline mt-1" href="">Agricultural products</a>
                    </li>
                    <li class="list-group-item table-item">
                      <div><i class="far fa-fw fa-dot-circle mr-1"></i> Data points</div>
                      <div>13</div>
                    </li>
                    <li class="list-group-item table-item">
                      <div><i class="far fa-fw fa-database mr-1"></i> Source(s)</div>
                      <div><a href="https://metabolismofcities.org/resources/publications/851">Freight Transport</a></div>
                    </li>
                    <li class="list-group-item table-item">
                      <div><i class="far fa-fw fa-user mr-1"></i> Uploaded by</div>
                      <div><a href="">Fulano de Tal</a></div>
                    </li>
                    <li class="list-group-item table-item">
                      <div><i class="far fa-fw fa-calendar-day mr-1"></i> Upload date</div>
                      <div>12 March 2018</div>
                    </li>
                  </ul>
                </div>
                <div class="col-lg-6">
                  <div class="alert alert-light">
                    <strong>Replication</strong>
                    <ol>
                      <li>Enter the IBSA website http://ibsa.brussels</li>
                      <li>Go in Themes page</li>
                      <li>Go in Mobility and Transport page</li>
                      <li>Download the Freight Transport .xls file (available just in French)</li>
                    </ol>
                  </div>
                </div>
              </div>
            </div>

            <!-- data -->
            <div class="tab-pane" id="tab-data">
              <a class="btn btn-primary mb-4" href=""><i class="fas fa-download"></i> Download data</a>
              <a class="btn btn-primary-basic mb-4" href="">Report an error</a>

              <div class="table-wrapper">
                <div class="alert alert-light">
                  <h3 class="mb-0">
                    <i class="fal fa-spinner-third fa-spin mr-4"></i>
                    Loading table
                  </h3>
                </div>
              </div>
            </div>

            <!-- share -->
            <div class="tab-pane" id="tab-share">
              <div class="form-group">
                <input id="share-url" class="form-control" value="https://metabolismofcities.org/cities/the-hague/datasets/52/" readonly>
              </div>

              <button class="btn btn-primary copy-url">
                <i class="fas fa-copy"></i> Copy URL
              </button>
              <a class="btn btn-primary" href="">
                <i class="fab fa-linkedin"></i> LinkedIn
              </a>
              <a class="btn btn-primary" href="">
                <i class="fab fa-twitter"></i> Twitter
              </a>
              <a class="btn btn-primary" href="">
                <i class="fab fa-facebook-square"></i> Facebook
              </a>
              <a class="btn btn-primary" href="">
                <i class="fas fa-envelope"></i> E-mail
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>

    <button type="submit" class="btn btn-success mt-4" form="dataset">
      <i class="fas fa-fw fa-save"></i>
      Save dataset
    </button>
  </section>
{% endblock %}

{% block footer %}
  <!-- load datatables -->
  <script src="{% static 'js/datatables.min.js' %}"></script>
  <script>
    // enable datatables
    $("table").DataTable();

    // copy url
    const copyUrlButton = $(".copy-url");

    copyUrlButton.click(function() {
      $("#share-url").select();
      document.execCommand("copy");

      copyUrlButton.html("<i class='fas fa-check'></i> Copied to clipboard");

      window.setTimeout(function() {
        copyUrlButton.html("<i class='fas fa-copy'></i> Copy URL");
      }, 3000);
    });
  </script>

  <!-- load highcharts -->
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="https://code.highcharts.com/modules/exporting.js"></script>
  <script>
    // user settings
    let colors = ["#144d58", "#ff8a4e", "#ED561B", "#DDDF00", "#24CBE5", "#64E572", "#FF9655", "#FFF263", "#6AF9C4"];
    let title = "Agricultural product and foodstuffs unloaded in the Port of Brussels 2005-2017";
    let subtitle = "Agricultural product and foodstuffs that are offloaded in the port of Brussels through maritime traffic";
    let chartTypes = ["column", "bar"]
    let startingChart = "column";
    let xAxisLabelText = null;
    let yAxisLabelText = "Population (millions)";
    let showLegend = false;
    let showMap = true;

    // function to gather user settings and generate dataset preview
    function generatePreview() {
      // set button icon to load
      $(".btn-generate-preview i").toggleClass("fa-cog fa-spin fa-eye");

      $("#preview").removeAttr("hidden")

      // gather user settings
      // titles
      title = $("#title").val()
      subtitle = $("#subtitle").val()

      // chart types
      chartTypes = []
      $(".chart-types input").each(function() {
        let input = $(this)
        if (input.is(":checked")) {
          chartTypes.push(input.attr("id"));
        }
      })

      // initial chart type
      startingChart = $("#initial-chart-type").val()

      // x-axis
      xAxisLabelText = $("#xaxis-label").is(":checked") ? $(".xaxis-label-text input").val() : null;

      // y-axis
      yAxisLabelText = $("#yaxis-label").is(":checked") ? $(".yaxis-label-text input").val() : null;

      // legend
      showLegend = $("#legend").is(":checked") ? true : false;

      // map
      showMap = $("#map").is(":checked") ? true : false;

      // take variables and apply them to the preview
      // titles
      $(".preview-title").text(title)
      $(".preview-subtitle").text(subtitle)

      // chart types
      $("select.change-chart-type").html("");
      $(chartTypes).each(function() {
        chartValue = this
        chartName = this.charAt(0).toUpperCase() + this.slice(1);

        $("select.change-chart-type").append("<option value='" + chartValue + "'>"+ chartName + "</option>");
      })

      // initial chart type
      $("select.change-chart-type").val(startingChart);

      // map
      if (showMap) {
        $("a.tab-map").show();
      } else {
        $("a.tab-map").hide();
      }

      // update chart
      chart.update({
        chart: {
          type: startingChart,
        },
        xAxis: {
          title: {
            text: xAxisLabelText
          }
        },
        yAxis: {
          title: {
            text: yAxisLabelText
          }
        },
        legend: {
          enabled: showLegend
        },
      });

      // revert button icon
      $(".btn-generate-preview i").toggleClass("fa-cog fa-spin fa-eye");
      scrollToID("preview")
    }

    $(".btn-generate-preview").click(function() {
      generatePreview();
    })

    // update initial chart type select when changing available chart types
    $(".chart-types input").change(function() {
      let type = $(this).attr("id");

      if ( $(this).is(":checked") ) {
        $("#initial-chart-type option[value='" + type + "']").removeAttr("hidden")
      } else {
        $("#initial-chart-type option[value='" + type + "']").attr("hidden", "hidden")
      }
    })

    // highchart defaults
    const defaultFont = "Lato, Helvetica Neue, Arial, Helvetica, sans-serif";

    Highcharts.setOptions({
      colors: colors,
    });

    var chart = Highcharts.chart("chart", {
      chart: {
        type: startingChart,
        animation: false,
        style: {
          fontFamily: defaultFont
        },
      },

      title: {
        text: title,
      },

      subtitle: {
        text: subtitle
      },

      xAxis: {
        lineColor: "#808080",
        type: "category",
        title: {
          text: xAxisLabelText,
          margin: 30,
          style: {
            fontSize: "14px",
          }
        },
        labels: {
          style: {
            fontSize: "14px",
          }
        }
      },

      yAxis: {
        min: 0,
        gridLineColor: "#efefef",
        lineColor: "#808080",
        title: {
          text: yAxisLabelText,
          margin: 30,
          style: {
            fontSize: "14px",
          }
        },
        labels: {
          style: {
            fontSize: "14px",
          }
        }
      },

      legend: {
        enabled: showLegend
      },

      tooltip: {
        pointFormat: "Population in 2017: <b>{point.y:.1f} millions</b>"
      },

      exporting: {
        enabled: false,
        scale: 4,
      },

      plotOptions: {
        series: {
          animation: false
        }
      },

      credits: {
        text: "Generated by Metabolism of Cities",
        href: null,
        style: {
          fontSize: "12px",
          cursor: "default",
        },
      },

      series: [{
        name: 'Population',
        data: [
          ['Shanghai', 24.2],
          ['Beijing', 20.8],
          ['Karachi', 14.9],
          ['Shenzhen', 13.7],
          ['Guangzhou', 13.1],
          ['Seoul', 9.8],
          ['Foshan', 9.3],
          ['Tokyo', 9.3]
        ],
      }]
    });

    // export chart buttons
    $(".export-png").click(function() {
      chart.exportChart();
    });

    $(".export-svg").click(function() {
      chart.exportChart({type:"image/svg+xml"});
    });

    // fullscreen chart button
    $(".fullscreen-chart").click(function() {
      chart.fullscreen.toggle();
    })

    // set type on default
    $(".change-chart-type").val("column");

    // change chart type
    $(".change-chart-type").change(function() {
      let chartType = $(this).val()

      chart.update({
        chart: {
          type: chartType,
        },
      });
    });

    // when opening data tab, load table with ajax
    let dataLoaded = false;

    $(".nav-link.load-data").click(function() {
      console.log("hi!");
      if (!dataLoaded) {
        $.get("the/url").done(function(data) {
          $(".table-wrapper").html(data);
          dataLoaded = true;
        });
      }
    });
  </script>
{% endblock %}