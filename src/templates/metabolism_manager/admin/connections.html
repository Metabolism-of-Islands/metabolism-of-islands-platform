{% extends "_base.html" %}

{% block title %}Connections between organisations{% endblock %}

{% block css %}
<style>
  #connections {
    height: 700px;
    max-height: 90vh;
  }

  #map {
    height: 600px;
  }
</style>
{% endblock %}

{% block content %}

<h1 class="mb-4">Connections between organisations</h1>

<div id="map" class="border mb-4" hidden></div>

<section>
  <div id="connections" class="border"></div>
</section>

<section>
  <table class="table datatable bg-white">
    <thead>
      <tr>
        <th>Organisation A</th>
        <th>Organisation B</th>
        <th>Connection</th>
      </tr>
    </thead>
    <tbody>
      {% for each in connections %}
        <tr>
          <td><a href="{% url 'platformu:admin_entity' my_organization.id each.record_parent.id %}">{{ each.record_parent }}</a></td>
          <td><a href="{% url 'platformu:admin_entity' my_organization.id each.record_child.id %}">{{ each.record_child }}</a></td>
          <td>{{ each.meta_data.dependency }}</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</section>

{% endblock %}

{% block footer %}
<!-- add connections to map -->
<script>
  function showMap() {
    $("#map").removeAttr("hidden")

    // create the array with all the connections
    let connections = [
      {% for each in connections %}
        {% if each.record_parent.meta_data.lat and each.record_parent.meta_data.lng and each.record_child.meta_data.lat and each.record_child.meta_data.lng %}
          {
              "type": "Feature",
              "properties": {
                "dependency": "{{ each.meta_data.dependency }}",
              },
              "geometry": {
                  "type": "LineString",
                  "coordinates": [[{{ each.record_parent.meta_data.lng }}, {{ each.record_parent.meta_data.lat }}], [{{ each.record_child.meta_data.lng }}, {{ each.record_child.meta_data.lat }}]],
              }
          },
        {% endif %}
      {% endfor %}
    ];

    // set the style depending on the dependency
    let connectionLines = L.geoJSON(connections, {
      style: function(feature) {
        switch (feature.properties.dependency) {
          case 'Low':    return {color: "green"};
          case 'Medium': return {color: "blue"};
          case 'High':   return {color: "red"};
          default:       return {color: "black"};
        }
      }
    })

    // add connections to the map
    connectionLines.addTo(map);

    // zoom the map to the polyline
    map.fitBounds(connectionLines.getBounds());
  }
</script>

<!-- add connections to network graph -->
<script src="https://code.highcharts.com/modules/networkgraph.js"></script>
<script>
  const defaultFont = "Lato, Helvetica Neue, Arial, Helvetica, sans-serif";

  Highcharts.setOptions({
    colors: ["#daeaf5"]
  });

  Highcharts.chart("connections", {
    credits: {
      text: "Generated by PlatformU",
      href: null,
      style: {
        fontSize: "12px",
        cursor: "default",
      },
    },
    plotOptions: {
      networkgraph: {
        layoutAlgorithm: {
          integration: "verlet",
        }
      },
      series: {
        states: {
          inactive: {
            linkOpacity: 0,
            opacity: 0,
          }
        },
      }
    },
    tooltip: false,
    exporting: {
      scale: 4,
    },
    chart: {
      type: "networkgraph",
      style: {
        fontFamily: defaultFont
      },
    },
    title: false,
    series: [{
      dataLabels: {
        enabled: true,
        linkFormat: "",
        padding: 10,
        style: {
          fontSize: "14px",
        },
      },
      states: {
        inactive: {
          linkOpacity: 0.01,
          opacity: 0.01,
        }
      },
      point: {
        events: {
          click: function () {
            console.log(this.options)
          }
        }
      },
      marker: {
        radius: 10,
        lineWidth: 2,
        lineColor: "#016FB9",
        states: {
          inactive: {
            linkOpacity: 0.01,
            opacity: 0.01,
          }
        },
      },
      data: [
        {% for each in connections %}
          {
            from: "{{ each.record_parent }}",
            to: "{{ each.record_child }}",
            className: "test",
            color: "{% if each.meta_data.dependency == 'Low' %}#666{% elif each.meta_data.dependency == 'Medium' %}#333{% elif each.meta_data.dependency == 'High' %}#000{% endif %}",
            width: "{% if each.meta_data.dependency == 'Low' %}2{% elif each.meta_data.dependency == 'Medium' %}4{% elif each.meta_data.dependency == 'High' %}5{% endif %}",
            custom: {
              link: "{% url 'platformu:admin_entity' my_organization.id each.id %}",
            },
          },
        {% endfor %}
      ]
    }]
  });
</script>
{% endblock %}