<script type="text/javascript">

  /*
   * FIRST WE DEFINE SOME FUNCTIONS AND CONSTANTS THAT ARE CALLED LATER, WHEN PARTICULAR
   * EVENTS ARE TRIGGERED
   *
  */

  /* Used to format numbers later on */
  const formatter = new Intl.NumberFormat('fr-FR', {
    maximumFractionDigits: 0
  });

  flow_titles = {}
  ignore_size = []
  {% for each in flows %}
    flow_titles["path-{{ each.identifier }}"] = "{{ each.name|escapejs }}";
    {% if not each.normal_width_calculation %}
      ignore_size.push({{each.identifier }});
    {% endif %}
  {% endfor %}

  /* We use this in the charts, on the x-axis */
  time_frames = []
  {% for each in time_frames %}
    {% if each.timeframe == "month" %}
      time_frames.push("{{ each.date|date:"M Y" }}");
    {% else %}
      time_frames.push("{{ each.date|date:"Y" }}");
    {% endif %}
  {% endfor %}

  /*
  *  flow_mapping is used to calculate the total quantity flowing into a node, so that
  *  the label on the box can be updated to reflect this quantity
  *  all_nodes and node_mapping is used to connect all the flows to their relevant nodes. 
  *  That way we can hide a node if not a single one of its flows is present.
  *  The format is : flow_mapping[flow_id] = [node, node, node]
  *  node_mapping is the opposite, where we figure out which flows are linked to a node
  *  so that we can hide the node if no flows are linked to it
  */

  node_mapping = {};
  flow_mapping = {};
  all_nodes = []
  {% for each in nodes %}
    all_nodes.push({{ each.identifier }});
    {% for flow in each.entry_flows.all %}
      if (!flow_mapping[{{ flow.identifier }}]) {
        flow_mapping[{{ flow.identifier }}] = [{{ each.identifier }}];
      } else {
        flow_mapping[{{ flow.identifier }}].push({{ each.identifier }});
      }
      if (!node_mapping[{{ each.identifier }}]) {
        node_mapping[{{ each.identifier }}] = [{{ flow.identifier }}];
      } else {
        node_mapping[{{ each.identifier }}].push({{ flow.identifier }});
      }
    {% endfor %}
    {% for flow in each.exit_flows.all %}
      if (!node_mapping[{{ each.identifier }}]) {
        node_mapping[{{ each.identifier }}] = [{{ flow.identifier }}];
       } else {
        node_mapping[{{ each.identifier }}].push({{ flow.identifier }});
       }
    {% endfor %}
  {% endfor %}

  function errorMessage(message) {
    alert(message);
  }

  show_data = false

  function getData() {
    /*  We start by fading out the map and showing a loading icon */
    $("svg").css("opacity", "0.2");
    $(".loading").show();

    /* Let's build the URL */
    category = {{ category.id }};
    var jsonURL = "{% url "water:ajax" %}?category=" + category + "&level=" + $("input[name=level]").val();

    $(".region-bar a.btn-dark").each(function(){
      var region = $(this).data("region");
      jsonURL += "&region=" + region;
    });

    jsonURL += "&date_start=" + $("select[name='date_start']").val() + "&date_end=" + $("select[name='date_end']").val();

    $.getJSON(jsonURL)
    .done(function(response) {
      items = [];
      max_flow = 0;

      /* Used for debugging, showing data on-screen */
      if (show_data) {
        data_box = "QUERY: " + jsonURL + '\n\nRESPONSE:\n';
        $.each(response, function(key, val) {
          data_box += 'Flow ' + key + ': ' + val + '\n';
        });
        $("#show_data_box").text(data_box);
      }

      /*  First we get the total value of ALL flows */
      $.each(response, function(key, val) {
        /* Some of the flows are so large that they should be ignored, so let's make sure it's NOT one of those */
        key = parseInt(key);
        index = ignore_size.indexOf(key);
        if (val > max_flow && index == -1) {
          max_flow = val;
        }
      });

      max_width = 10;
      all_flows = [];
      node_totals = {}
      /* every time we run this script, we copy all_nodes into hidden_nodes
      *  so that all nodes are hidden until they are removed from this list
      *  as matching flows appear 
      */
      hidden_nodes = [...all_nodes];

      {% for each in flows %}
        all_flows.push({{ each.identifier }});
      {% endfor %}

      $.each(response, function(key, val) {
        if (val == null) {
          $("#path-" + key).css("stroke-width", "0.3px");
          $("#path-" + key).attr("title", "Inconnu");
        } else {
          fraction = val/max_flow; /* Here we can calculate the flow proportionate to the max_flow */
          width = fraction*max_width; /* This makes the width of THIS flow proportionate to the max */
          if (width > 0 && width < 0.3) {
            width = 0.3;
          }
          $("#path-" + key).css("stroke-width", width + "px");
          $("#path-" + key).attr("title", "FLOW #" + key + " - " + formatter.format(val) + " {{ category.unit.symbol }}");
        }

        if (val == null || val > 0) {
          /* If this flow has a value (or is UNKNOWN), then we should automatically SHOW all the nodes that are 
          *  related to this flow. We do this by removing the node from the hidden_nodes array
          */
          for ([node, included_flows] of Object.entries(node_mapping)) {
            for (var i = 0; i < included_flows.length; i++) {
              if (included_flows[i] == key) {
                node = parseInt(node);
                index = hidden_nodes.indexOf(node);
                if (index !== -1) {
                  hidden_nodes.splice(index, 1); // 2nd parameter means remove one item only
                }
              }
            }
          }
        }

        $("#path-" + key).attr("data-toggle", "tooltip");
        $("#path-" + key).attr("data-placement", "left");
        $("#path-" + key).show();

        all_flows = all_flows.filter(item => item !== Number(key)); /* We keep track which flows exist in the dataset, see below why */

        // So let's see which node a flow belongs to, and then we add the total to that node
        if (flow_mapping[key]) {
          for (let node_id of flow_mapping[key]) {
            if (node_totals[node_id]) {
              node_totals[node_id] += val;
            } else {
              node_totals[node_id] = val;
            }
          }
        }

      });

      for (const [node_id, node_total] of Object.entries(node_totals)) {
        if (node_total == null) {
          $("#node-" + node_id + " .qty").text("");
        } else {
          $("#node-" + node_id + " .qty").text(formatter.format(node_total) + " {{ category.unit.symbol }}");
        }
      }

      /* Whichever flow was NOT included in the ajax response needs to be removed from the map */
      $.each(all_flows, function(index, value) {
        $("#path-" + value).hide("fast");
      });

      $("svg").css("opacity", "1");
      $(".loading").hide(); 

      $('[data-toggle="tooltip"]').tooltip({container: 'body'});

      // We want to hide all the nodes that should not be displayed, and show the ones that do have values
      $(".node").addClass("show-this-node");
      for (let node of hidden_nodes) {
        get_node = $("#node-" + node);
        if (get_node.is(":visible")) {
          get_node.hide("fast");
        }
        get_node.removeClass("show-this-node");
      }
      $(".show-this-node").show("fast");

    })
    .fail(function() {
      errorMessage("Failed to load data. Are you connected to the internet? Please reload the page or try again later.")
    })
  }

  function setDateLabels() {
    start_date = $("select[name='date_start']").val();
    end_date = $("select[name='date_end']").val();
    if (start_date.length == 4 && end_date.length == 4) {
      if (start_date == end_date) {
        /* Start and end dates are both years, and they are the same */
        date_label = start_date;
      } else {
        /* Start and end dates are both years, but they are different */
        date_label = start_date + "-" + end_date;
      }
      $(".title_date").html(date_label);
    } else {
      /* If there are months involved, then we want to show e.g. Jan 2022-Dec 2023 */
      /* To do so, we need to convert this to date objects and then reformat */
      var options = { year: "numeric", month: "short" };

      if (start_date.length == 4) {
        start_date = start_date + "-01-01";
      } else {
        start_date = start_date + "-01";
      }
      start_date = new Date(start_date);
      start_date_label = start_date.toLocaleDateString("fr-FR", options);

      if (end_date.length == 4) {
        end_date = end_date + "-12-01"; /* If a year is selected, then we show 'Dec XXXX' so cast to December date */
      } else {
        end_date = end_date + "-01";
      }
      end_date = new Date(end_date);
      end_date_label = end_date.toLocaleDateString("fr-FR", options);

      if ($("select[name='date_start']").val() == $("select[name='date_end']").val()) {
        date_label = start_date_label;
      } else {
        date_label = start_date_label + "-" + end_date_label;
      }

      $(".watergraphs p .title_date").html(date_label);
    }
  }

  /*
   * THESE ARE PARTICULAR EVENTS THAT TRIGGER ACTION
   *
  */

  function setRegionLabels() {

    var activated_regions = $(".region-bar a.btn-dark").length;
    title_region = "";
    $(".region-bar a.btn-dark").each(function(){
      title_region += $(this).text() + ", ";
    });
    title_region = title_region.substring(0, title_region.length - 2);
    $("#title_region").html(title_region);

    if ($(".region-bar a[data-region='1']").hasClass("btn-dark")) {
      /*  Either ALL or NO region activated, so fallback to Eau d'Azur */
      $(".map-region").addClass("active-space");
    } else {
      $(".map-region").removeClass("active-space");
      $(".region-bar a.btn-dark").each(function(){
        var region = $(this).data("region");
        $("#space-"+region).addClass("active-space");
      });
    }

  }

  $(".region-bar a").click(function(e){
    e.preventDefault();
    var region = $(this).data("region");

    if (region == "1") {
      /* Eau d'azur button is pressed so we remove all regions and only activate this one */
      $(".region-bar a").removeClass("btn-dark");
      $(this).addClass("btn-dark");
    } else {
      $(".region-bar a[data-region='1']").removeClass("btn-dark");
      if ($(this).hasClass("btn-dark")) {
        isActive = true;
      } else {
        isActive = false;
      }

      if (isActive) {
        $(this).removeClass("btn-dark");
      } else {
        $(this).addClass("btn-dark");
      }
    }

    var activated_regions = $(".region-bar a.btn-dark").length;
    if (activated_regions == 6 || activated_regions == 0 || $(".region-bar a[data-region='1']").hasClass("btn-dark")) {
      /*  Either ALL or NO region activated, so fallback to Eau d'Azur */
      $(".region-bar a").removeClass("btn-dark");
      $(".region-bar a[data-region='1']").addClass("btn-dark");
    }

    setRegionLabels();
    getData();

  });

  $("#current-period").click(function(e){
    e.preventDefault();
    if ($(".period-dropdown").is(":visible")) {
      $(".period-dropdown").slideUp("fast");
      $("#current-period .bi-caret-down").show();
      $("#current-period .bi-caret-up").hide();
    } else {
      $(".period-dropdown").slideDown("fast");
      $("#current-period .bi-caret-down").hide();
      $("#current-period .bi-caret-up").show();
    }
  });

  $("#animate").click(function(){
    if ($(this).is(":checked")) {
      $(".path").css("stroke-dasharray", "1");
      $(".animate-toggle label").addClass("btn-dark");
    } else {
      $(".path").css("stroke-dasharray", "0");
      $(".animate-toggle label").removeClass("btn-dark");
    }
  });

  $("#changedate").submit(function(e){
    e.preventDefault();
    setDateLabels();
    getData();
  });


  /* We need to resize the sidebar so that it fits on the screen without the need to scroll */
  var bodyWidth = $(window).width();
  if (bodyWidth > 990) {
    var $sidebar = $("#sidebar-container");
    var sidebarHeight = $sidebar.outerHeight();

    var bodyHeight = $(window).height();

    var $toplayer = $(".top-layer");
    var toplayerHeight = $toplayer.outerHeight();

    /* We calculate the total available height by getting the body's height and removing the height of the */
    /* top menu, and then taking 10px off that in order to leave some space. */
    availableHeight = bodyHeight-toplayerHeight-10;

    if (sidebarHeight > availableHeight) {
      proportion = availableHeight/sidebarHeight;
      difference = availableHeight-sidebarHeight;
      move_by = (100-(proportion*100))/2
      $sidebar.css({
        transform: "translate(0, -" + move_by + "%) " + "scale(" + proportion + ")"
      });
    }
  }

  // If you click on a flow then we show a chart with all historic data for the entire period
  $(".path").click(function(){
    get_id = $(this).attr("id");
    title = flow_titles[get_id];

    $("#chartTitle").text("Territoire : " + $("#title_region").text());
    $("#chart").modal();

    $("#chartbox").highcharts().setTitle({text:title});

    if ($("#chartbox").highcharts().get("chart_data")) {
      $("#chartbox").highcharts().get("chart_data").remove();
    };

    get_id_number = get_id.split("-")[1]; // The id will be something like 'path-51' so we need to get just 51
    jsonURL = "{% url "water:ajax_chart_data" %}?flow=" + get_id_number + "&category={{ category.id }}";

    $(".region-bar a.btn-dark").each(function(){
      jsonURL += "&space=" + $(this).data("region");
    });

    $.getJSON(jsonURL)
    .done(function(response) {
      $("#chartbox").highcharts().addSeries({ id: "chart_data", data: response}); 
    })
    .fail(function() {
      errorMessage("Failed to load data. Are you connected to the internet? Please reload the page or try again later.")
    })
  });

  // We load an empty highchart, which will be populated with actual chart data once
  // a flow is being clicked.
  Highcharts.chart("chartbox", {
      credits: {
        text: "",
        href: null,
        style: {
          fontSize: "12px",
          cursor: "default",
        },
      },
      chart: {
          type: "column"
      },
      title: {
          align: "left"
      },
      legend: {
          enabled: false
      },
      yAxis: {
        title: {
          text: "{{ _("Value") }} ({{ category.unit.symbol }})",
        },
      },
  });

  // Button to save the sankey as a file
  // Source: https://gist.github.com/danallison/3ec9d5314788b337b682

  function downloadString(text, fileType, fileName) {
    var blob = new Blob([text], { type: fileType });

    var a = document.createElement('a');
    a.download = fileName;
    a.href = URL.createObjectURL(blob);
    a.dataset.downloadurl = [fileType, a.download, a.href].join(':');
    a.style.display = "none";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    setTimeout(function() { URL.revokeObjectURL(a.href); }, 1500);
  }

  $("#download").click(function(e){
    e.preventDefault();
    downloadString($("#sankey_svg")[0].outerHTML, "image/svg+xml", "{{ category.slug }}.svg")
  });

  /* Run this at page load */
  $("#space-{{ request.GET.region }}").addClass("active-space");

  /* Each of the maps becomes semi-transparent if it is not highlighted, 
   * but this means that the flows that are drawn underneath become visible,
   * which is not desired. The solution is to copy all of the maps, and to
   * make those maps completely white, so that they are a background to 
   * cover the flow itself while allowing for a transparent upper-layer
  */
  $(".map-region").each(function(){
    map_copy = $(this).clone()
    map_copy.insertBefore(this);
    id = map_copy.attr("id");
    map_copy.attr("id", "clone-" + id);
    map_copy.removeClass("map-region");
    map_copy.removeClass("active-space");
    map_copy.addClass("clone-region");
  });

  setDateLabels();
  setRegionLabels();
  getData();

</script>

{% if is_admin %}
<script type="text/javascript">
$(function(){
  $("#show_nodes").click(function(){
    $(this).addClass("btn-default");
    $(this).removeClass("btn-default-outline");
    $(".node").show();
  });
  $("#show_node_numbers").click(function(){
    $(this).addClass("btn-default");
    $(this).removeClass("btn-default-outline");
    $(".node").each(function(){
      node_name = $(this).attr("id");
      $(this).find("text:last").text(node_name);
    });
  });
  $("#show_flows").click(function(){
    $(this).addClass("btn-default");
    $(this).removeClass("btn-default-outline");
    $(".path").show();
    $(".path").css("stroke-width", "2");
  });
  $("#show_data").click(function(){
    $(this).addClass("btn-default");
    $(this).removeClass("btn-default-outline");
    show_data = true;
    getData();
  });
});
</script>
{% endif %}
