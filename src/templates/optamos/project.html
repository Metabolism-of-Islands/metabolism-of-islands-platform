{% extends "optamos/_base.html" %}
{% load moc_extras %}

{% block title %}
  {{ project }}
{% endblock %}

{% block css %}
  <style>
  .slider input {
    -webkit-appearance: none;
    appearance: none;
    height: 8px;
    background: #e5e7eb;
    border-radius: 9999px;
    outline: none;
  }
  .slider input::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 24px;
    height: 24px;
    background: #3b82f6;
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
  }
  .slider input::-moz-range-thumb {
    width: 24px;
    height: 24px;
    background: #3b82f6;
    border-radius: 50%;
    cursor: pointer;
    border: none;
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
  }
  .slider input::-webkit-slider-runnable-track {
    height: 8px;
    background: #e5e7eb;
    border-radius: 9999px;
  }
  </style> 
{% endblock %}

{% block content %}

<div class="flex">
  <div class="flex-1 border-r border-gray-200 py-10 relative">

    <a href="{% url "optamos:project_settings" project.uid %}" class="absolute top-4 right-4 btn-white btn-sm">
      <svg xmlns="http://www.w3.org/2000/svg" class="size-5" viewBox="0 -960 960 960" fill="currentColor"><path d="M200-200h57l391-391-57-57-391 391v57Zm-80 80v-170l528-527q12-11 26.5-17t30.5-6q16 0 31 6t26 18l55 56q12 11 17.5 26t5.5 30q0 16-5.5 30.5T817-647L290-120H120Zm640-584-56-56 56 56Zm-141 85-28-29 57 57-29-28Z"/></svg>
      Edit project
    </a>

    <section id="criteria" class="pr-5">
      <h2>Rank options</h2>
      {% if criteria_list %}
        <ul>
        {% for each in criteria_list %}
          <li>
            <a href="{% url "optamos:project" project.uid %}?criteria={{ each.id }}" 
              class="group flex gap-x-3 rounded-md p-2 text-sm/6 font-semibold no-underline
              {% if each == criteria %}
                text-white bg-sky-600 
              {% else %}
                text-gray-700 hover:bg-gray-50 hover:text-sky-600 
              {% endif %}
             ">

              {% if each.is_done %}
              <span class="flex size-6 shrink-0 items-center justify-center rounded-lg border border-gray-200 bg-lime-400 text-[0.625rem] font-medium {% if each == criteria %}text-sky-600 border-sky-600{% else %}text-gray-400{% endif %} group-hover:border-sky-600 group-hover:text-sky-600">
                <svg class="h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><!--!Font Awesome Free v7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--><path d="M530.8 134.1C545.1 144.5 548.3 164.5 537.9 178.8L281.9 530.8C276.4 538.4 267.9 543.1 258.5 543.9C249.1 544.7 240 541.2 233.4 534.6L105.4 406.6C92.9 394.1 92.9 373.8 105.4 361.3C117.9 348.8 138.2 348.8 150.7 361.3L252.2 462.8L486.2 141.1C496.6 126.8 516.6 123.6 530.9 134z"/></svg>
              </span>
              {% else %}
                <span class="flex size-6 shrink-0 items-center justify-center rounded-lg border border-gray-200 bg-white text-[0.625rem] font-medium {% if each == criteria %}text-sky-600 border-sky-600{% else %}text-gray-400{% endif %} group-hover:border-sky-600 group-hover:text-sky-600">{{ each.name|first }}</span>
              {% endif %}

              <span class="truncate">{{ each }}</span>
            </a>
          </li>
        {% endfor %}

        </ul>
      {% else %}
        <div class="alert alert-warning">
          You need to configure criteria for your project.
          <a href="{% url "optamos:project_settings" project.uid %}">Click here</a> to 
          edit your project.
        </div>
      {% endif %}

      <h2 class="mt-10">Rank criteria</h2>
      <ul>
        <li>
          <a href="{% url "optamos:project" project.uid %}?rank_all_criteria=true" 
            class="group flex gap-x-3 rounded-md p-2 text-sm/6 font-semibold no-underline
            {% if page == "rank_all_criteria" %}
              text-white bg-sky-600 
            {% else %}
              text-gray-700 hover:bg-gray-50 hover:text-sky-600 
            {% endif %}
           ">

            {% if criteria_values == total_required_criteria_values %}
            <span class="flex size-6 shrink-0 items-center justify-center rounded-lg border border-gray-200 bg-lime-400 text-[0.625rem] font-medium {% if page == "rank_all_criteria" %}text-sky-600 border-sky-600{% else %}text-gray-400{% endif %} group-hover:border-sky-600 group-hover:text-sky-600">
              <svg class="h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><!--!Font Awesome Free v7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--><path d="M530.8 134.1C545.1 144.5 548.3 164.5 537.9 178.8L281.9 530.8C276.4 538.4 267.9 543.1 258.5 543.9C249.1 544.7 240 541.2 233.4 534.6L105.4 406.6C92.9 394.1 92.9 373.8 105.4 361.3C117.9 348.8 138.2 348.8 150.7 361.3L252.2 462.8L486.2 141.1C496.6 126.8 516.6 123.6 530.9 134z"/></svg>
            </span>
            {% else %}
              <span class="flex size-6 shrink-0 items-center justify-center rounded-lg border border-gray-200 bg-white text-[0.625rem] font-medium {% if page == "rank_all_criteria" %}text-sky-600 border-sky-600{% else %}text-gray-400{% endif %} group-hover:border-sky-600 group-hover:text-sky-600">R</span>
            {% endif %}

            <span class="truncate">Rank all criteria</span>
          </a>
        </li>
      </ul>

    </section>

    <section class="mt-10" id="inconsistency">
      <h2>Results</h2>
        <ul class="pr-5">
          <li>
            <a href="{% url "optamos:project_results" project.uid %}" 
              class="group flex gap-x-3 rounded-md p-2 text-sm/6 font-semibold no-underline
              {% if page == "results" %}
                text-white bg-sky-600 
              {% else %}
                text-gray-700 hover:bg-gray-50 hover:text-sky-600 
              {% endif %}
             ">
              <span class="truncate">Results</span>
            </a>
          </li>
          <li>
            <a href="{% url "optamos:project_sensitivity" project.uid %}" 
              class="group flex gap-x-3 rounded-md p-2 text-sm/6 font-semibold no-underline
              {% if page == "sensitivity" %}
                text-white bg-sky-600 
              {% else %}
                text-gray-700 hover:bg-gray-50 hover:text-sky-600 
              {% endif %}
             ">
              <span class="truncate">Sensitity analysis</span>
            </a>
          </li>
        </ul>
    </section>

    <section class="mt-10" id="inconsistency">
      <h2>Consistency ratio</h2>
      Current ratio:
      {{ cr|floatformat:2 }}
      <br>
      {% if cr < 0.10 %}
        <span class="text-lime-600 font-bold">✓ Acceptable</span>
      {% else %}
        <span class="text-red-600 font-bold">✗ Inconsistent</span>
      {% endif %}
    </section>

  </div>
  <div class="flex-2 py-10 px-10">

    {% if request.GET.criteria or page == "rank_all_criteria" %}
      {% if criteria %}
        <h1>{{ criteria }}</h1>
        <p>
          With respect to this criteria ({{ criteria }}), how would you compare the following options?
          For each pair, how strongly do you prefer one over the other?</p>
        <p class="text-gray-700 text-sm"> Use the blue circle to indicate
          which option is preferred. The number indicates how strong your preference is 
          (1 = equally preferred; 3 = slightly more preferred; 5 = strongly more preferred, 7 = very strongly more preferred,
          9 = extremely more preferred). 
        </p>
      {% else %}
        <h1 class="mb-0 text-xl">Rank all criteria</h1>
        <p>
          Indicate how you different criteria compare across the following pairs. Indicate which criteria
          is more important. 
        </p>
        <p class="text-gray-700 text-sm"> Use the blue circle to indicate
          the relative importance of each criteria. The number indicates how strong the relative importance is 
          (1 = equally important; 3 = slightly more important; 5 = strongly more important, 7 = very strongly more important,
          9 = extremely more important). 
        </p>
      {% endif %}

      {% if not pairs %}
        <div class="alert alert-warning">
          You need to configure at least two 
          {% if page == "rank_all_criteria" %}criteria{% else %}options{% endif %}
          in your project.
          <a href="{% url "optamos:project_settings" project.uid %}">Click here</a> to 
          edit your project.
        </div>
      {% else %}
        <form method="post" class="mt-10">
          {% for option1, option2 in pairs %}
            <section class="mb-10">
              <div class="flex justify-between">
                <span class="truncate w-2/5">{{ option1 }}</span>
                <span class="truncate w-2/5 text-right">{{ option2 }}</span>
              </div>
              <div class="slider">
                {% with label="range-"|concat:option1.id|concat:"-"|concat:option2.id %}
                  <input name="{{ label }}" type="range" min="-8" max="8" value="{{ values|get_item:label|default_if_none:0 }}" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-sky-500 hover:accent-sky-600 range range-lg range-primary">
                {% endwith %}
                <output class="block mt-2 text-center text-lg font-bold text-gray-900"></output>
              </div>
            </section>
          {% endfor %}
          {% csrf_token %}

          {% if page == "rank_all_criteria" %}
            <p class="flex justify-end">
              <button type="submit" class="btn-green">Save &amp; finish</button>
            </p>
          {% else %}
            <p class="flex justify-{% if criteria == criteria_list.0 %}end{% else %}between{% endif %}">
              {% if criteria != criteria_list.0 %}
                <button type="submit" name="back" value="true" class="btn-white">← Save &amp; back</button>
              {% endif %}
              <button type="submit" class="btn-green">Save &amp; next →</button>
            </p>
          {% endif %}

        </form>
      {% endif %}

    {% elif page == "home" %}

      <div class="bg-gray-100 shadow-sm sm:rounded-lg">
        <div class="px-4 py-5 sm:p-6">
          <div class="mt-2 sm:flex sm:items-start sm:justify-between">
            <div class="mt-5 sm:mt-0 sm:mr-6 sm:flex sm:shrink-0 sm:items-center">
              <div class="group relative inline-flex w-11 shrink-0 rounded-full bg-gray-200 p-0.5 inset-ring inset-ring-gray-900/5 outline-offset-2 outline-sky-600 transition-colors duration-200 ease-in-out has-checked:bg-sky-600 has-focus-visible:outline-2">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="currentColor" stroke="currentColor" aria-hidden="true" class="mx-auto size-12 text-gray-700"><path d="M400-240 160-480l240-240 56 58-142 142h486v80H314l142 142-56 58Z"/></svg>
              </div>
            </div>
            <div class="max-w-xl text-sm text-gray-600">
              <p>
                Select one of the options from the menu on the left-hand side to get started.
                You can also <a href="{% url "optamos:project_settings" project.uid %}">edit your project settings</a>, <a href="{% url "optamos:projects" %}">view all your projects</a>, or <a href="{% url "optamos:project_create" %}">create a new project</a>.
              </p>
            </div>
          </div>
        </div>
      </div>

    {% elif page == "results" %}
      <div class="relative h-20">
        {% for each in criteria_list %}
          {% if not each.is_done %}
            <div class="alert alert-warning absolute">
              <svg xmlns="http://www.w3.org/2000/svg" class="inline mr-1" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor"><path d="m40-120 440-760 440 760H40Zm138-80h604L480-720 178-200Zm302-40q17 0 28.5-11.5T520-280q0-17-11.5-28.5T480-320q-17 0-28.5 11.5T440-280q0 17 11.5 28.5T480-240Zm-40-120h80v-200h-80v200Zm40-100Z"/></svg>
              <strong class="mr-2">WARNING</strong>
              The results are incomplete - not all information is entered yet.
            </div>
          {% endif %}
        {% endfor %}

        {% if criteria_values != total_required_criteria_values %}
          <div class="alert alert-warning absolute">
              <svg xmlns="http://www.w3.org/2000/svg" class="inline mr-1" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor"><path d="m40-120 440-760 440 760H40Zm138-80h604L480-720 178-200Zm302-40q17 0 28.5-11.5T520-280q0-17-11.5-28.5T480-320q-17 0-28.5 11.5T440-280q0 17 11.5 28.5T480-240Zm-40-120h80v-200h-80v200Zm40-100Z"/></svg>
              <strong class="mr-2">WARNING</strong>
            The results are incomplete - not all information is entered yet.
          </div>
        {% endif %}
      </div>

      <div id="chart_options" style="width:100%;height: 400px;"></div>
      <div id="chart_criteria" style="width:100%;height: 400px;"></div>

      <h1 class="mt-5">Summary table</h1>

      <table class="table table-striped">
        <thead>
          <tr>
            <th>Criterion</th>
            {% for o in options %}
              <th>{{ o.name }}</th>
            {% endfor %}
            <th>CR</th>
            <th>% Importance</th>
          </tr>
        </thead>
        <tbody>
          {% for row in summary_table %}
            <tr>
              <th>{{ row.criterion }}</th>
              {% for val in row.options %}
                <td>{{ val|floatformat:1 }}%</td>
              {% endfor %}
              <td>{{ row.cr|floatformat:2 }}</td>
              <td>{{ row.importance|floatformat:1 }}%</td>
            </tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr>
            <th>Totals</th>
            {% for total in summary_totals %}
              <th>{{ total|floatformat:1 }}%</th>
            {% endfor %}
            <th colspan="2"></th>
          </tr>
        </tfoot>
      </table>

    <h3 class="mt-8">Global Scores & Ranking</h3>
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Rank</th>
          <th>Option</th>
          <th>Percentage</th>
        </tr>
      </thead>
      <tbody>
        {% for item in global_ranking %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td>{{ item.option.name }}</td>
            <td>{{ item.score|multiply:100|floatformat:1 }}%</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

    <div class="mt-5 p-5 bg-gray-100 flex justify-between">
      <a class="btn btn-blue" href="?export=true">Excel data export</a>
      <a class="btn btn-blue" href="#full-details" id="view-details">View all calculations</a>
    </div>

    <div id="full-details" class="hidden">
      <h1 class="mt-5">Criteria evaluation</h1>
      <table class="table table-striped">
        <thead>
          <tr>
            <th></th>
            {% for c in matrix_criteria %}
              <th>{{ c.name }}</th>
            {% endfor %}
          </tr>
        </thead>

        <tbody>
          {% for row in matrix_criteria %}
            <tr>
              <th>{{ row.name }}</th>
              {% for col in matrix_criteria %}
                <td>
                  {{ matrix|get_item:row.name|get_item:col.name|floatformat:2 }}
                </td>
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>

        <tfoot>
          <tr>
            <th>TOTAL</th>
            {% for col in matrix_criteria %}
              <th>
                {{ column_totals|get_item:col.id|floatformat:2 }}
              </th>
            {% endfor %}
          </tr>
        </tfoot>

      </table>

      <h3 class="mt-5">Normalized Matrix</h3>

      <table class="table table-striped">
        <thead>
          <tr>
            <th></th>
            {% for c in matrix_criteria %}
              <th>{{ c.name }}</th>
            {% endfor %}
            <th>TOTAL</th>
            <th>AVERAGE</th>
          </tr>
        </thead>

        <tbody>
          {% for row in matrix_criteria %}
            <tr>
              <th>{{ row.name }}</th>
              {% for col in matrix_criteria %}
                <td>
                  {{ normalized_matrix|get_item:row.id|get_item:col.id|floatformat:2 }}
                </td>
              {% endfor %}
              <td>
                {{ row_totals|get_item:row.id|floatformat:2 }}
              </td>
              <td style="font-weight: bold;">
                {{ row_averages|get_item:row.id|floatformat:2 }}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>

      <h3 class="mt-5">Consistency Check</h3>

      <table class="table table-striped">
        <tbody>
          <tr>
            <th>λ max</th>
            <td>{{ lambda_max|floatformat:4 }}</td>
          </tr>
          <tr>
            <th>Consistency Index (CI)</th>
            <td>{{ ci|floatformat:4 }}</td>
          </tr>
          <tr>
            <th>Consistency Ratio (CR)</th>
            <td>
              {{ cr|floatformat:4 }}
              {% if cr < 0.10 %}
                <span class="text-lime-600 font-bold">✓ Acceptable</span>
              {% else %}
                <span class="text-red-600 font-bold">✗ Inconsistent</span>
              {% endif %}
            </td>
          </tr>
        </tbody>
      </table>

      <hr class="mt-5">
      <h1 class="mt-5">Options evaluation</h1>

    {% for c in criteria %}
      <h3 class="mt-5">Criterion: {{ c.name }}</h3>

      <h4 class="mt-5">Raw Matrix</h4>
      <table class="table table-striped">
        <thead>
          <tr>
            <th></th>
            {% for o in options %}
              <th>{{ o.name }}</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for row in options %}
            <tr>
              <th>{{ row.name }}</th>
              {% for col in options %}
                <td>
                  {{ option_matrices|get_item:c.id|get_item:row.id|get_item:col.id|floatformat:2 }}
                </td>
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>

      <h4 class="mt-5">Normalized Matrix</h4>

      <p>Consistency Ratio (CR) for this criterion: 
         {{ option_crs|get_item:c.id|floatformat:2 }}
      </p>

      <table class="table table-striped">
        <thead>
          <tr>
            <th></th>
            {% for o in options %}
              <th>{{ o.name }}</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for row in options %}
            <tr>
              <th>{{ row.name }}</th>
              {% for col in options %}
                <td>
                  {{ normalized_option_matrices|get_item:c.id|get_item:row.id|get_item:col.id|floatformat:2 }}
                </td>
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>

      <!-- Option weights -->
      <h4 class="mt-5">Option Weights (Row Averages)</h4>
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Option</th>
            <th>Weight</th>
            <th>Percentage</th>
          </tr>
        </thead>
        <tbody>
          {% for o in options %}
            <tr>
              <td>{{ o.name }}</td>
              <td>
                {{ option_weights|get_item:c.id|get_item:o.id|floatformat:2 }}
              </td>
              <td>
                {{ option_weights|get_item:c.id|get_item:o.id|multiply:100|floatformat:1 }}%
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>

    {% endfor %}

    </div>

    {% elif page == "sensitivity" %}

      <h1>Sensitivity analysis</h1>

      <form id="sensitivity-form">
        {% for each in importance %}
          <div class="mb-10">
            <label for="weight_{{ each.id }}" class="block text-sm font-medium text-gray-700">{{ each.name }}</label>

            <input
              type="range"
              id="weight_{{ each.id }}"
              name="weight_{{ each.id }}"
              data-id="{{ each.id }}"
              min="0"
              max="100"
              value="{{ each.value|floatformat:0 }}"
              class="mt-1 w-full h-2 bg-gray-200 rounded-lg cursor-pointer range"
            />

            <span
              id="weight_value_{{ each.id }}"
              class="mt-2 text-lg font-semibold"
            >
              {{ each.value|floatformat:0 }}%
            </span>
          </div>
        {% endfor %}
      </form>

      <h2 class="mt-10 text-lg font-bold">Adjusted Results</h2>
      <div id="chart_options" style="width:100%;height: 400px;"></div>

    {% endif %}

  </div>
</div>

{% endblock %}

{% block js %}

{% if page == "results" or page == "sensitivity" %}
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/echarts@6.0.0/dist/echarts.min.js"></script>
  <script type="text/javascript">

    $("#view-details").click(function(e){
      $(this).hide();
      $("#full-details").show();
    });

    {% if page == "results" %}
      var chart_criteria = echarts.init(document.getElementById('chart_criteria'));
      var criteria_config = {
        title: {
          text: 'Criteria importance'
        },
        xAxis: {
          type: 'value'
        },
        yAxis: {
          type: 'category',
          data: [{% for each in importance %}'{{ each.name|escapejs }}'{% if not forloop.last %},{% endif %}{% endfor %}],
          inverse: true
        },
        series: [{
          name: 'Criteria',
          type: 'bar',
          data: [{% for each in importance %}{{ each.value }}{% if not forloop.last %},{% endif %}{% endfor %}],
          showBackground: true,
          backgroundStyle: {
            color: 'rgba(220, 220, 220, 0.3)'
          },
          itemStyle: {
            color: function(params) {
              return new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                { offset: 0, color: '#0084d1' },
                { offset: 0.5, color: '#0678ba' },
                { offset: 1, color: '#0c6fa9' }
              ]);
            },
            borderRadius: [0, 5, 5, 0]
          }
        }]
      };
      chart_criteria.setOption(criteria_config);
    {% endif %}

    var chart_options = echarts.init(document.getElementById('chart_options'));
    var options_config = {
      title: {
        text: 'Options'
      },
      xAxis: {
        type: 'value'
      },
      yAxis: {
        type: 'category',
        data: [{% for each in options %}'{{ each.name|escapejs }}'{% if not forloop.last %},{% endif %}{% endfor %}],
        inverse: true
      },
      series: [{
        name: 'Option',
        type: 'bar',
        data: [{% for each in summary_totals %}{{ each }}{% if not forloop.last %},{% endif %}{% endfor %}],
        showBackground: true,
        backgroundStyle: {
          color: 'rgba(220, 220, 220, 0.3)'
        },
        itemStyle: {
          color: function(params) {
            return new echarts.graphic.LinearGradient(0, 0, 0, 1, [
              { offset: 0, color: '#ff6900' },
              { offset: 0.5, color: '#e66810' },
              { offset: 1, color: '#c8580a' }
            ]);
          },
          borderRadius: [0, 5, 5, 0]
        }
      }]
    };
    chart_options.setOption(options_config);

  </script>

  {% if page == "sensitivity" %}

<script type="text/javascript">
$(function(){
  let debounceTimer;
  $("input[type=range]").on("input", function() {
    clearTimeout(debounceTimer);
    var slider = $(this);
    var critId = slider.data("id");
    var value = slider.val();

    $("#weight_value_" + critId).text(value + "%");

    debounceTimer = setTimeout(function() {

      $.ajax({
        url: "{% url 'optamos:project_sensitivity' project.uid %}",
        type: "POST",
        data: {
          "criterion_id": critId,
          "new_weight": value,
          "csrfmiddlewaretoken": "{{ csrf_token }}"
        },
        success: function(data) {

            // Update sliders with new weights
            $.each(data.adjusted_weights, function(id, weight) {
                var sliderElem = $("#weight_" + id);
                sliderElem.val(weight.toFixed(0));
                $("#weight_value_" + id).text(weight.toFixed(0) + "%");
            });

            // Update the chart
            var names = [];
            var scores = [];
            $.each(data.sensitivity_ranking, function(i, item) {
                names.push(item.option_name);
                scores.push(item.score);
            });

            chart_options.setOption({
                yAxis: { data: names },
                series: [{ data: scores }]
            });
        },
        error: function(xhr, status, error) {
            $("input[type=range]").prop("disabled", true).fadeTo(150, 0.5);
            $("#chart_options").fadeTo(150, 0.5);
            console.error("Sensitivity update failed:", error);
            alert("Sorry, an error ocurred. Please reload the page");
        }
      });

    }, 150); // wait 150ms after last input
  });
});
</script>

  {% endif %}

{% else %}
  <script type="text/javascript">
    $(function() {
      $(".slider").each(function() {
        const $container = $(this);
        const $slider = $container.find('input[type="range"]');
        const $output = $container.find("output");
        const $option1 = $container.siblings(".flex").find("span").first();
        const $option2 = $container.siblings(".flex").find("span").last();
        
        function updateOpacity() {
          const value = parseInt($slider.val(), 10);
          $output.text(value);    
          const maxOpacity = 1;
          const minOpacity = 0.3;
          const opacity2 = (value < 0) ? maxOpacity - (value / -8) * (1-minOpacity) : 1;
          const opacity1 = (value > 0) ? maxOpacity - (value / 8) * (1-minOpacity) : 1;
          
          $option1.css("opacity", opacity1);
          $option2.css("opacity", opacity2);
        }
        
        updateOpacity();
        $slider.on("input", updateOpacity);
      });
    });
  </script>
{% endif %}

{% endblock %}
