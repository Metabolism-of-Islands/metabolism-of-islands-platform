{% extends "optamos/_base.html" %}
{% load moc_extras %}

{% block title %}
  {{ project }}
{% endblock %}

{% block content %}

<div class="flex">
  <div class="flex-1 border-r border-gray-200 py-10 relative">

    <a href="{% url "optamos:project_settings" project.uid %}" class="absolute top-4 right-4 btn-white btn-sm">
      <svg xmlns="http://www.w3.org/2000/svg" class="size-5" viewBox="0 -960 960 960" fill="currentColor"><path d="M200-200h57l391-391-57-57-391 391v57Zm-80 80v-170l528-527q12-11 26.5-17t30.5-6q16 0 31 6t26 18l55 56q12 11 17.5 26t5.5 30q0 16-5.5 30.5T817-647L290-120H120Zm640-584-56-56 56 56Zm-141 85-28-29 57 57-29-28Z"/></svg>
      Edit project
    </a>

    <section id="criteria" class="pr-5">
      <h2>Criteria</h2>
      {% if criteria_list %}
        <ul>
        {% for each in criteria_list %}
          <li>
            <a href="{% url "optamos:project" project.uid %}?criteria={{ each.id }}" 
              class="group flex gap-x-3 rounded-md p-2 text-sm/6 font-semibold no-underline
              {% if each == criteria %}
                text-white bg-sky-600 
              {% else %}
                text-gray-700 hover:bg-gray-50 hover:text-sky-600 
              {% endif %}
             ">

              {% if each.is_done %}
              <span class="flex size-6 shrink-0 items-center justify-center rounded-lg border border-gray-200 bg-lime-400 text-[0.625rem] font-medium {% if each == criteria %}text-sky-600 border-sky-600{% else %}text-gray-400{% endif %} group-hover:border-sky-600 group-hover:text-sky-600">
                {% if not each == criteria %}
                  <svg class="h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><!--!Font Awesome Free v7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--><path d="M530.8 134.1C545.1 144.5 548.3 164.5 537.9 178.8L281.9 530.8C276.4 538.4 267.9 543.1 258.5 543.9C249.1 544.7 240 541.2 233.4 534.6L105.4 406.6C92.9 394.1 92.9 373.8 105.4 361.3C117.9 348.8 138.2 348.8 150.7 361.3L252.2 462.8L486.2 141.1C496.6 126.8 516.6 123.6 530.9 134z"/></svg>
                {% endif %}
              </span>
              {% else %}
                <span class="flex size-6 shrink-0 items-center justify-center rounded-lg border border-gray-200 bg-white text-[0.625rem] font-medium {% if each == criteria %}text-sky-600 border-sky-600{% else %}text-gray-400{% endif %} group-hover:border-sky-600 group-hover:text-sky-600">{{ each.name|first }}</span>
              {% endif %}

              <span class="truncate">{{ each }}</span>
            </a>
          </li>
        {% endfor %}

        <li>
          <a href="{% url "optamos:project" project.uid %}?rank_all_criteria=true" 
            class="group flex gap-x-3 rounded-md p-2 text-sm/6 font-semibold no-underline
            {% if page == "rank_all_criteria" %}
              text-white bg-sky-600 
            {% else %}
              text-gray-700 hover:bg-gray-50 hover:text-sky-600 
            {% endif %}
           ">

            {% if criteria_values == total_required_criteria_values %}
            <span class="flex size-6 shrink-0 items-center justify-center rounded-lg border border-gray-200 bg-lime-400 text-[0.625rem] font-medium {% if page == "rank_all_criteria" %}text-sky-600 border-sky-600{% else %}text-gray-400{% endif %} group-hover:border-sky-600 group-hover:text-sky-600">
              {% if not page == "rank_all_criteria" %}
                <svg class="h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><!--!Font Awesome Free v7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--><path d="M530.8 134.1C545.1 144.5 548.3 164.5 537.9 178.8L281.9 530.8C276.4 538.4 267.9 543.1 258.5 543.9C249.1 544.7 240 541.2 233.4 534.6L105.4 406.6C92.9 394.1 92.9 373.8 105.4 361.3C117.9 348.8 138.2 348.8 150.7 361.3L252.2 462.8L486.2 141.1C496.6 126.8 516.6 123.6 530.9 134z"/></svg>
              {% endif %}
            </span>
            {% else %}
              <span class="flex size-6 shrink-0 items-center justify-center rounded-lg border border-gray-200 bg-white text-[0.625rem] font-medium {% if page == "rank_all_criteria" %}text-sky-600 border-sky-600{% else %}text-gray-400{% endif %} group-hover:border-sky-600 group-hover:text-sky-600">R</span>
            {% endif %}

            <span class="truncate">Rank all criteria</span>
          </a>
        </li>

        </ul>
      {% else %}
        <div class="alert alert-warning">
          You need to configure criteria for your project.
          <a href="{% url "optamos:project_settings" project.uid %}">Click here</a> to 
          edit your project.
        </div>
      {% endif %}
    </section>

    <section class="mt-10" id="inconsistency">
      <h2>Results</h2>
        <ul class="pr-5">
          <li>
            <a href="{% url "optamos:project_results" project.uid %}" 
              class="group flex gap-x-3 rounded-md p-2 text-sm/6 font-semibold no-underline
              {% if page == "results" %}
                text-white bg-sky-600 
              {% else %}
                text-gray-700 hover:bg-gray-50 hover:text-sky-600 
              {% endif %}
             ">
              <span class="truncate">Results</span>
            </a>
          </li>
          <li>
            <a href="{% url "optamos:project_sensitivity" project.uid %}" 
              class="group flex gap-x-3 rounded-md p-2 text-sm/6 font-semibold no-underline
              {% if page == "sensitivity" %}
                text-white bg-sky-600 
              {% else %}
                text-gray-700 hover:bg-gray-50 hover:text-sky-600 
              {% endif %}
             ">
              <span class="truncate">Sensitity analysis</span>
            </a>
          </li>
        </ul>
    </section>

    <section class="mt-10" id="inconsistency">
      <h2>Consistency ratio</h2>
      Current ratio:
      {{ cr|floatformat:4 }}
      <br>
      {% if cr < 0.10 %}
        <span class="text-lime-600 font-bold">✓ Acceptable</span>
      {% else %}
        <span class="text-red-600 font-bold">✗ Inconsistent</span>
      {% endif %}
    </section>

  </div>
  <div class="flex-2 py-10 px-10">

      <div class="relative h-20">
        {% for each in criteria_list %}
          {% if not each.is_done %}
            <div class="alert alert-warning absolute">
              <svg xmlns="http://www.w3.org/2000/svg" class="inline mr-1" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor"><path d="m40-120 440-760 440 760H40Zm138-80h604L480-720 178-200Zm302-40q17 0 28.5-11.5T520-280q0-17-11.5-28.5T480-320q-17 0-28.5 11.5T440-280q0 17 11.5 28.5T480-240Zm-40-120h80v-200h-80v200Zm40-100Z"/></svg>
              <strong class="mr-2">WARNING</strong>
              The results are incomplete - not all information is entered yet.
            </div>
          {% endif %}
        {% endfor %}

        {% if criteria_values != total_required_criteria_values %}
          <div class="alert alert-warning absolute">
              <svg xmlns="http://www.w3.org/2000/svg" class="inline mr-1" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor"><path d="m40-120 440-760 440 760H40Zm138-80h604L480-720 178-200Zm302-40q17 0 28.5-11.5T520-280q0-17-11.5-28.5T480-320q-17 0-28.5 11.5T440-280q0 17 11.5 28.5T480-240Zm-40-120h80v-200h-80v200Zm40-100Z"/></svg>
              <strong class="mr-2">WARNING</strong>
            The results are incomplete - not all information is entered yet.
          </div>
        {% endif %}
      </div>

      <div id="chart_criteria" style="width:100%;height: 400px;"></div>
      <div id="chart_options" style="width:100%;height: 400px;"></div>

      <h1 class="mt-5">Summary table</h1>

      <table class="table table-striped">
        <thead>
          <tr>
            <th>Criterion</th>
            {% for o in options %}
              <th>{{ o.name }}</th>
            {% endfor %}
            <th>CR</th>
            <th>% Importance</th>
          </tr>
        </thead>
        <tbody>
          {% for row in summary_table %}
            <tr>
              <th>{{ row.criterion }}</th>
              {% for val in row.options %}
                <td>{{ val|floatformat:1 }}%</td>
              {% endfor %}
              <td>{{ row.cr|floatformat:2 }}</td>
              <td>{{ row.importance|floatformat:1 }}%</td>
            </tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr>
            <th>Totals</th>
            {% for total in summary_totals %}
              <th>{{ total|floatformat:1 }}%</th>
            {% endfor %}
            <th colspan="2"></th>
          </tr>
        </tfoot>
      </table>

      <h1 class="mt-5">Criteria evaluation</h1>
      <table class="table table-striped">
        <thead>
          <tr>
            <th></th>
            {% for c in matrix_criteria %}
              <th>{{ c.name }}</th>
            {% endfor %}
          </tr>
        </thead>

        <tbody>
          {% for row in matrix_criteria %}
            <tr>
              <th>{{ row.name }}</th>
              {% for col in matrix_criteria %}
                <td>
                  {{ matrix|get_item:row.name|get_item:col.name|floatformat:2 }}
                </td>
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>

        <tfoot>
          <tr>
            <th>TOTAL</th>
            {% for col in matrix_criteria %}
              <th>
                {{ column_totals|get_item:col.id|floatformat:2 }}
              </th>
            {% endfor %}
          </tr>
        </tfoot>

      </table>

      <h3 class="mt-5">Normalized Matrix</h3>

      <table class="table table-striped">
        <thead>
          <tr>
            <th></th>
            {% for c in matrix_criteria %}
              <th>{{ c.name }}</th>
            {% endfor %}
            <th>TOTAL</th>
            <th>AVERAGE</th>
          </tr>
        </thead>

        <tbody>
          {% for row in matrix_criteria %}
            <tr>
              <th>{{ row.name }}</th>
              {% for col in matrix_criteria %}
                <td>
                  {{ normalized_matrix|get_item:row.id|get_item:col.id|floatformat:4 }}
                </td>
              {% endfor %}
              <td>
                {{ row_totals|get_item:row.id|floatformat:4 }}
              </td>
              <td style="font-weight: bold;">
                {{ row_averages|get_item:row.id|floatformat:4 }}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>

      <h3 class="mt-5">Consistency Check</h3>

      <table class="table table-striped">
        <tbody>
          <tr>
            <th>λ max</th>
            <td>{{ lambda_max|floatformat:4 }}</td>
          </tr>
          <tr>
            <th>Consistency Index (CI)</th>
            <td>{{ ci|floatformat:4 }}</td>
          </tr>
          <tr>
            <th>Consistency Ratio (CR)</th>
            <td>
              {{ cr|floatformat:4 }}
              {% if cr < 0.10 %}
                <span class="text-lime-600 font-bold">✓ Acceptable</span>
              {% else %}
                <span class="text-red-600 font-bold">✗ Inconsistent</span>
              {% endif %}
            </td>
          </tr>
        </tbody>
      </table>

      <hr class="mt-5">
      <h1 class="mt-5">Options evaluation</h1>

    {% for c in criteria %}
      <h3 class="mt-5">Criterion: {{ c.name }}</h3>

      <h4 class="mt-5">Raw Matrix</h4>
      <table class="table table-striped">
        <thead>
          <tr>
            <th></th>
            {% for o in options %}
              <th>{{ o.name }}</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for row in options %}
            <tr>
              <th>{{ row.name }}</th>
              {% for col in options %}
                <td>
                  {{ option_matrices|get_item:c.id|get_item:row.id|get_item:col.id|floatformat:4 }}
                </td>
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>

      <h4 class="mt-5">Normalized Matrix</h4>

      <p>Consistency Ratio (CR) for this criterion: 
         {{ option_crs|get_item:c.id|floatformat:4 }}
      </p>

      <table class="table table-striped">
        <thead>
          <tr>
            <th></th>
            {% for o in options %}
              <th>{{ o.name }}</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for row in options %}
            <tr>
              <th>{{ row.name }}</th>
              {% for col in options %}
                <td>
                  {{ normalized_option_matrices|get_item:c.id|get_item:row.id|get_item:col.id|floatformat:4 }}
                </td>
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>

      <!-- Option weights -->
      <h4 class="mt-5">Option Weights (Row Averages)</h4>
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Option</th>
            <th>Weight</th>
            <th>Percentage</th>
          </tr>
        </thead>
        <tbody>
          {% for o in options %}
            <tr>
              <td>{{ o.name }}</td>
              <td>
                {{ option_weights|get_item:c.id|get_item:o.id|floatformat:4 }}
              </td>
              <td>
                {{ option_weights|get_item:c.id|get_item:o.id|multiply:100|floatformat:1 }}%
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>

    {% endfor %}

    <!-- Global scores -->
    <h3 class="mt-5">Global Scores & Ranking</h3>
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Rank</th>
          <th>Option</th>
          <th>Global Score</th>
          <th>Percentage</th>
        </tr>
      </thead>
      <tbody>
        {% comment %} Sort by descending global score in view before passing {% endcomment %}
        {% for item in global_ranking %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td>{{ item.option.name }}</td>
            <td>{{ item.score|floatformat:4 }}</td>
            <td>{{ item.score|multiply:100|floatformat:1 }}%</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

  </div>
</div>

{% endblock %}

{% block js %}

  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/echarts@6.0.0/dist/echarts.min.js"></script>
  <script type="text/javascript">
    var chart_criteria = echarts.init(document.getElementById('chart_criteria'));
    var criteria_config = {
      title: {
        text: 'Criteria importance'
      },
      xAxis: {
        type: 'value'
      },
      yAxis: {
        type: 'category',
        data: [{% for each in criteria_list %}'{{ each|escapejs }}'{% if not forloop.last %},{% endif %}{% endfor %}]
      },
      series: [{
        name: 'Criteria',
        type: 'bar',
        data: [{% for each in criteria_list %}{{ points_criteria|get_item:each }}{% if not forloop.last %},{% endif %}{% endfor %}],
        showBackground: true,
        backgroundStyle: {
          color: 'rgba(220, 220, 220, 0.3)'
        },
        itemStyle: {
          color: function(params) {
            return new echarts.graphic.LinearGradient(0, 0, 0, 1, [
              { offset: 0, color: '#0084d1' },
              { offset: 0.5, color: '#0678ba' },
              { offset: 1, color: '#0c6fa9' }
            ]);
          },
          borderRadius: [0, 5, 5, 0]
        }
      }]
    };
    chart_criteria.setOption(criteria_config);

    var chart_options = echarts.init(document.getElementById('chart_options'));
    var options_config = {
      title: {
        text: 'Options'
      },
      xAxis: {
        type: 'value'
      },
      yAxis: {
        type: 'category',
        data: [{% for each in project.options.all %}'{{ each|escapejs }}'{% if not forloop.last %},{% endif %}{% endfor %}]
      },
      series: [{
        name: 'Option',
        type: 'bar',
        data: [{% for each in project.options.all %}{{ points_options|get_item:each }}{% if not forloop.last %},{% endif %}{% endfor %}],
        showBackground: true,
        backgroundStyle: {
          color: 'rgba(220, 220, 220, 0.3)'
        },
        itemStyle: {
          color: function(params) {
            return new echarts.graphic.LinearGradient(0, 0, 0, 1, [
              { offset: 0, color: '#ff6900' },
              { offset: 0.5, color: '#e66810' },
              { offset: 1, color: '#c8580a' }
            ]);
          },
          borderRadius: [0, 5, 5, 0]
        }
      }]
    };
    chart_options.setOption(options_config);

  </script>

{% endblock %}
