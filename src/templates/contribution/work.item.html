{% extends "_base.html" %}
{% block page_name %}work item{% endblock %}

{% block head %}
  <meta name="robots" content="nofollow" />
  <style type="text/css">
  .card .list-group-item.table-item > div:last-of-type {
    opacity:0.5;
  }
  </style>
{% endblock %}

{% block content %}

  <h1>{{ info }}</h1>
  <a href="../" class="btn btn-primary-basic mb-4">
    <i class="fal fa-angle-left"></i>
    Back to work list
  </a>

  <div class="row">
    <div class="col-md-6 pr-md-4">
      <div class="sticky-top">
        <div class="description">
          {% if info.description %}
            {{ info.get_markdown_description|safe }}
          {% endif %}
          <small class="text-muted">Created on {{ info.date_created|date:"l j F Y, H:i" }}</small>
        </div>

        <div class="card my-4">
          <ul class="list-group list-group-flush">
            <li class="list-group-item table-item">
              <div><i class="far fa-fw fa-play mr-1" aria-hidden="true"></i> {{ info.get_status_display }}</div>
              <div>Status</div>
            </li>
            <li class="list-group-item table-item">
              <div><i class="far fa-fw fa-thermometer-half mr-1" aria-hidden="true"></i> {{ info.get_priority_display }}</div>
              <div>Priority</div>
            </li>
            <li class="list-group-item table-item">
              <div><i class="far fa-fw fa-box mr-1" aria-hidden="true"></i> {{ info.workactivity }}</div>
              <div>Type</div>
            </li>
            {% if info.related_to %}
              <li class="list-group-item table-item">
                <div><i class="far fa-fw fa-link mr-1"></i> {{ info.related_to }}</div>
                <div>Related to</div>
              </li>
            {% endif %}
            <li class="list-group-item table-item">
              <div><i class="far fa-fw fa-user mr-1"></i> {{ info.assigned_to }}</div>
              <div>Assigned to</div>
            </li>
          </ul>
        </div>

        {% if request.user.is_authenticated %}
          {% if info.assigned_to != request.user.people %}

            <form method="post" id="assign-me">
              <input type="hidden" name="assign_to_me" value="true" />
              {% csrf_token %}
            </form>

            <button class="btn btn-primary" type="submit" form="assign-me">
              <i class="fas fa-user-check"></i>
              Assign to me
            </button>

            <a class="btn btn-primary-basic" href="edit/?return={{ request.get_full_path }}">
              <i class="fal fa-edit"></i>
              Edit task
            </a>

          {% else %}

            <!-- putting all the forms here so that the buttons can be next to each other -->

            <form method="post" id="start-work">
              <input type="hidden" name="status_change" value="5" />
              {% csrf_token %}
            </form>

            <form method="post" id="mark-completed">
              <input type="hidden" name="status_change" value="2" />
              {% csrf_token %}
            </form>

            <form method="post" id="on-hold">
              <input type="hidden" name="status_change" value="4" />
              {% csrf_token %}
            </form>

            <form method="post" id="re-open">
              <input type="hidden" name="status_change" value="1" />
              {% csrf_token %}
            </form>

            <form method="post" id="discard">
              <input type="hidden" name="status_change" value="3" />
              {% csrf_token %}
            </form>

            <form method="post" id="unassign">
              <input type="hidden" name="status_change" value="1" />
              <input type="hidden" name="unassign" value="true" />
              {% csrf_token %}
            </form>

            {% if info.status == 1 or info.status == 4 %}

              <button class="btn btn-primary mb-2 mr-1" type="submit" form="start-work">
                <i class="fas fa-play"></i>
                Start work
              </button>

            {% endif %}

            {% if info.status == 1 or info.status == 4 or info.status == 5 %}

              <button class="btn btn-primary mb-2 mr-1" type="submit" form="mark-completed">
                <i class="fas fa-check"></i>
                Mark as completed
              </button>

            {% endif %}

            {% if info.status == 1 or info.status == 5 %}

              <button class="btn btn-primary mb-2 mr-1" type="submit" form="on-hold">
                <i class="fas fa-pause"></i>
                Put on hold
              </button>

            {% endif %}

            {% if info.status == 3 or info.status == 2 %}

              <button class="btn btn-primary mb-2 mr-1" type="submit" form="re-open">
                <i class="fas fa-redo"></i>
                Re-open
              </button>

            {% endif %}

            {% if info.status == 1 or info.status == 4 or info.status == 5 %}

              <button class="btn btn-primary mb-2 mr-1" type="submit" form="unassign">
                <i class="fas fa-user-times"></i>
                Unassign
              </button>

            {% endif %}

            <div class="mt-4">
              {% if info.status == 1 or info.status == 4 or info.status == 5 %}
                <button class="btn btn-danger mb-2 mr-1" type="submit" form="discard">
                  <i class="fas fa-trash-alt"></i>
                  Discard
                </button>
              {% endif %}

              <a class="btn btn-primary-basic mb-2 mr-1" href="edit/?return={{ request.get_full_path }}">
                <i class="fal fa-edit"></i>
                Edit task
              </a>
            </div>

          {% endif %}
        {% endif %}
      </div>
    </div>
    <div class="col-md-6 pl-md-4">
      {% include "_messages.html" %}
    </div>
  </div>

{% endblock %}

{% block footer %}
  <script>
    $(".forum").scrollTop($(".forum")[0].scrollHeight);
  </script>
{% endblock %}
