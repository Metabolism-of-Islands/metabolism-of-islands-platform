{% extends "_base.html" %}
{% load humanize %}
{% load static %}

{% block page_name %}work sprint fullwidth{% endblock %}

{% block css %}
  <style type="text/css">
  section{padding-top:0}
  section h1{font-size:2rem}
  .main-content.container{padding-top:0}
  
  body.fullwidth .container.main-content .fullwidth-wrapper{padding:2rem 0}
  .alert {
    display: inline-block;
    width: auto;
  }

  .alert-success {
    text-align: right;
  }

  .alert strong,
  .alert span {
    font-size: 13px;
    font-style: italic;
  }

  .alert p {
    margin: 0;
  }

  #chat > div {
    float: left;
    width: 100%;
  }
  </style>
{% endblock %}

{% block content %}

<div class="fullwidth-wrapper text-center mb-3">
  <h1>{{ info }} {{ room_id }}</h1>
  <p>
    {{ info.start_date|date:"l d F Y, H:i" }} -
    {{ info.end_date|date:"l d F Y, H:i" }} (<a href="https://www.timeanddate.com/worldclock/timezone/utc" target="_blank">UTC</a>)
  </p>
  <p><a href="../../?status=1">View task list</a> | <a href="http://">Sign up for this sprint</a>
  </p>

  <p style="display:none">
    {% for each in info.projects.all %}
      {{ each }} |
    {% endfor %}
  </p>
</div>

<div class="container pt-4">

  <div class="row">

    <!-- Area de trabajo Fer -->
    <section class="col-6">
      <h1>Chat</h1>

      <hr>
      <div id="chat">
        {% for message in messages %}
        <div>
          <div class="alert {% if message.user.id == user_id %} alert-success float-right {% else %} alert-info float-left {% endif %}">
            <strong>{{ message.people }}</strong>
            <p>{{ message.message }}</p>
            <span>{{ message.timestamp }}</span>
          </div>
        </div>    
        {% endfor %}
      </div>

      <input id="chat-message-input" type="text" size="50"><br>
      <input id="chat-message-submit" type="button" value="Send">
      {{ room_id|json_script:"room-name" }}

    </section>
    <!-- Fin de area de trabajo Fer -->

    <!-- Fer, favor no tocar esto -->
    <section class="col-6">
      <h4>Work updates</h4>
      <div class="forum mb-4">
        {% for each in updates %}
          <div class="single-message card mb-3">
            <div class="card-body">
              <div class="row metadata">
                <div class="col-6">
                  <img src="{{ each.author.image.thumbnail.url }}" alt="" class="avatar plus" />
                  {{ each.author }}
                </div>
                <div class="col-6 text-muted text-right avatar-line-height" title="{{ each.date_created|date:'l j F Y, H:i e' }}">
                  {{ each.date_created|naturaltime }}
                </div>
              </div>

              <hr>

              <div class="text">
                <a class="d-block mb-2" href="../../{{ each.parent.id }}/">{{ each.parent }}</a>

                {% if each.name == "Task assigned" %}
                  <i class="far fa-fw fa-user-check mr-1"></i>
                {% elif each.name == "Status change" %}
                  <i class="far fa-fw fa-retweet mr-1"></i>
                {% elif each.name == "Task unassigned" %}
                  <i class="far fa-fw fa-user-times mr-1"></i>
                {% elif each.name == "Task created" %}
                  <i class="far fa-fw fa-play mr-1"></i>
                {% endif %}

                {{ each.get_markdown_description|safe|truncatewords_html:30 }}
              </div>

              {% if each.getForumMessageFiles %}
                <div class="attachment mt-3">
                  {% for subeach in each.getForumMessageFiles %}
                    <a class="btn btn-sm btn-primary-outline mb-1" href="{{ MEDIA_URL }}{{ subeach.file.url }}" target="_blank"><i class="far fa-paperclip"></i> {{ subdetails.getFileName }}
                    </a>
                  {% endfor %}
                </div>
              {% endif %}

            </div>
          </div>
        {% endfor %}
      </div>
    </section>
  </div>
</div>

<script src="{% static 'js/reconnecting-websockets.js' %}"></script>
<script>
  const roomName = JSON.parse(document.getElementById('room-name').textContent);
  const userId = {{ user_id }}
  const favIcon = document.querySelector('link[rel="shortcut icon"]');
  const currentFavicon = "{% static 'img/favicon/favicon.ico' %}";
  const replaceFavicon = "https://backoffice.metabolismofcities.org/static/img/favicon-backoffice.png";

  var focused = true;



  const chatSocket = new ReconnectingWebSocket(
      'ws://'
      + window.location.host
      + '/ws/chat/'
      + roomName
      + '/'
  );

  chatSocket.onmessage = function(e) {
      const data = JSON.parse(e.data);
      const message = data["message"]
      const username = message.user;
      const user_id = message.user_id;

      let mainWrapperMessage = document.createElement("div");
      let wrapperMessage = document.createElement("div");
      let tagName = document.createElement("strong");
      tagName.textContent = username;

      let contentMessage = document.createElement("p");
      contentMessage.textContent = message.message;

      let timeMessage = document.createElement("span");
      timeMessage.textContent = message.timestamp;

      if (userId === user_id) {
        wrapperMessage.className = "alert-success";
        wrapperMessage.classList.add("float-right");

        favIcon.setAttribute('type', 'image/png');
        favIcon.setAttribute('href', currentFavicon);

      } else {
        wrapperMessage.className = "alert-info";
        wrapperMessage.classList.add("float-left");

        if (document.hidden) {
          favIcon.setAttribute('type', 'image/png');
          favIcon.setAttribute('href', replaceFavicon);
        }
      }

      wrapperMessage.classList.add("alert");
      wrapperMessage.appendChild(tagName);
      wrapperMessage.appendChild(contentMessage);
      wrapperMessage.appendChild(timeMessage);
      mainWrapperMessage.appendChild(wrapperMessage)

      document.querySelector('#chat').appendChild(mainWrapperMessage);
      
      //document.querySelector('#chat-log').value += (data.message + '\n');
  };

  chatSocket.onclose = function(e) {
      console.error('Chat socket closed unexpectedly');
  };

  document.querySelector('#chat-message-input').focus();
  document.querySelector('#chat-message-input').onkeyup = function(e) {
      if (e.keyCode === 13) {  // enter, return
          document.querySelector('#chat-message-submit').click();
      }
  };

  document.querySelector('#chat-message-submit').onclick = function(e) {
      const messageInputDom = document.querySelector('#chat-message-input');
      const message = messageInputDom.value;
      chatSocket.send(JSON.stringify({
          "message": message,
          "command": 'new_message',
          "channel": roomName,
          "user_id": userId,
          
      }));
      messageInputDom.value = '';
  };
</script>

{% endblock %}
