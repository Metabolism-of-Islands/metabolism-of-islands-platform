{% extends "_base.html" %}
{% load humanize %}

{% block page_name %}fullwidth{% endblock %}

{% block css %}
  <style type="text/css">
  section{padding-top:0}
  section h1{font-size:2rem}
  .main-content.container{padding-top:0}
  body.fullwidth .container.main-content .fullwidth-wrapper{padding:2rem 0}
  </style>
{% endblock %}

{% block content %}

<div class="fullwidth-wrapper text-center mb-3">
  <h1>{{ info }} {{ room_id }}</h1>
  <p>
    {{ info.start_date|date:"l M d, Y - H:i" }} -- 
    {{ info.end_date|date:"l M d, Y - H:i" }} (<a href="https://www.timeanddate.com/worldclock/timezone/utc" target="_blank">UTC</a>)
  </p>
</div>

<div class="container">

  <div class="row">

    <!-- Area de trabajo Fer --> 
    <section class="col-6">
      <h1>Chat</h1>
      
      <hr>
      <textarea id="chat-log" cols="50" rows="10"></textarea><br>
      <input id="chat-message-input" type="text" size="50"><br>
      <input id="chat-message-submit" type="button" value="Send">
      {{ room_id|json_script:"room-name" }}
      <script>
          const roomName = JSON.parse(document.getElementById('room-name').textContent);

          const chatSocket = new WebSocket(
              'ws://'
              + window.location.host
              + '/ws/chat/'
              + roomName
              + '/'
          );

          chatSocket.onmessage = function(e) {
              const data = JSON.parse(e.data);
              document.querySelector('#chat-log').value += (data.message + '\n');
          };

          chatSocket.onclose = function(e) {
              console.error('Chat socket closed unexpectedly');
          };

          document.querySelector('#chat-message-input').focus();
          document.querySelector('#chat-message-input').onkeyup = function(e) {
              if (e.keyCode === 13) {  // enter, return
                  document.querySelector('#chat-message-submit').click();
              }
          };

          document.querySelector('#chat-message-submit').onclick = function(e) {
              const messageInputDom = document.querySelector('#chat-message-input');
              const message = messageInputDom.value;
              chatSocket.send(JSON.stringify({
                  'message': message
              }));
              messageInputDom.value = '';
          };
      </script>

    </section>
    <!-- Fin de area de trabajo Fer -->

    <!-- Fer, favor no tocar esto --> 
    <section class="col-6">
      <h1>Work updates</h1>
      {% for each in updates %}
        <p>
          <strong>{{ each.author }}</strong>
          <code>{{ each.date_created|naturaltime }}</code>
          <br>
          <a href="../../{{ each.parent.id }}/">{{ each.parent }}</a>
        </p>
        {{ each.get_markdown_description|safe|truncatewords_html:30 }}
        <hr>
      {% endfor %}
    </section>

  </div>

</div>

{% endblock %}
