{% extends "_base.html" %}

{% block page_name %}address search{% endblock %}
{% block title %}Address search{% endblock %}

{% block css %}
{% endblock %}

{% block content %}
  <input type="text" class="form-control" placeholder="Type in your address" id="autocomplete-search">
  <div id="autocomplete-results" class="mt-3"></div>
  <form method="submit">
    <input id="lat" type="hidden" name="lat" value="" />
    <input id="lon" type="hidden" name="lng" value="" />
    <button class="btn btn-primary" type="submit" id="submit-coordinates" hidden>
      <i class="fas fa-paper-plane"></i>
      Submit
    </button>
  </form>
{% endblock %}

{% block footer %}
  <script>
    // these coordinates indicate where the search should prioritise, making the search more relevant
    const priorityLat = "50.8435";
    const priorityLon = "4.3688";

    function autoComplete(term) {
      $.get("https://api.geoapify.com/v1/geocode/autocomplete?text="+ term + "&lat=" + priorityLat + "&lon=" + priorityLon + "&apiKey=07dd7daebb4043f0af83301d6103452f")
      .done(function(response) {
        showAutocompleteResults(response)
      })
      .fail(function() {
        $("#autocomplete-results").html("<p>Address lookup failed, please reload the page and try again.")
      })
    };

    $("#autocomplete-search").keyup(function() {
      let searchTerm = $("#autocomplete-search").val()
      searchTerm = searchTerm.trim().replace(/\s/g,"+")

      if (searchTerm.length > 4) {
        autoComplete(searchTerm);
      };

      $("#submit-coordinates").attr("hidden", "hidden");
      $(".single-autocomplete-result").removeClass("selected")
    })

    function showAutocompleteResults(results) {
      $("#autocomplete-results").html("");
      $(results.features).each(function() {
        $("#autocomplete-results").append("<div class='single-autocomplete-result' data-lon='" + this.properties.lon + "' data-lat='" + this.properties.lat + "'>" + this.properties.formatted + "</div>")
      });
      enableResultFunction()
    };

    function enableResultFunction() {

      $(".single-autocomplete-result").click(function() {
        $(".single-autocomplete-result").removeClass("selected")
        $(this).addClass("selected");

        let lat = $(this).data("lat");
        let lon = $(this).data("lon");

        $("input#lat").val(lat);
        $("input#lon").val(lon);

        $("#submit-coordinates").removeAttr("hidden");
      })
    }
  </script>
{% endblock %}
